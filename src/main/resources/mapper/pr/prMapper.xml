<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.company.erp.pr.mapper.PrMapper">

    <select id="selectUserName" resultType="String">
        SELECT USER_NM FROM BY_USER
        WHERE USER_ID = #{userId}
    </select>

    <insert id="insertPrHd" parameterType="com.company.erp.pr.dto.PrHdDTO">
        INSERT INTO PRHD
        (PR_NUM, REG_DATE,REG_USER_ID,DEL_FLAG,PR_SUBJECT,
         DEPT_CD, PR_AMT, RMK,PROGRESS_CD,PC_TYPE)
        values
        (#{prNum},now(),#{regUserId},'N', #{prSubject}, #{deptCd},
        #{prAmt},#{rmk},

        (SELECT CODE FROM CODD
         WHERE CODE_GROUP='PROGRESS_CD'
         AND CODE_NAME= '임시저장'
         AND USE_YN = 'Y'),

        (SELECT CODE FROM CODD
         WHERE CODE_GROUP='PC_TYPE'
         AND CODE_NAME= #{pcType}
         AND USE_YN='Y')
        )
    </insert>

    <insert id="insertPrDt">
        INSERT INTO PRDT
        ( PR_NUM, ITEM_CD, ITEM_DESC, ITEM_SPEC,
        UNIT_CD, PR_QT, UNIT_PRC, PR_AMT, DELY_DATE,
        RMK, DEL_FLAG, REG_DATE, REG_USER_ID )
        VALUES
        <foreach collection="prDtList" item="dt" separator=",">
            ( #{dt.prNum}, #{dt.itemCd}, #{dt.itemDesc},
            #{dt.itemSpec}, #{dt.unitCd}, #{dt.prQt},
            #{dt.unitPrc}, #{dt.prAmt}, #{dt.delyDate},
            #{dt.rmk}, 'N', NOW(), #{dt.regUserId} )
        </foreach>
    </insert>

    <select id="selectPrItem" resultType="com.company.erp.pr.dto.PrItemDTO">
        SELECT ITEM_CD, ITEM_NM, ITEM_SPEC, UNIT_CD
        FROM MTGL
        WHERE DEL_FLAG = 'N'
        <if test="itemCode != null and itemCode != ''">
            AND ITEM_CD LIKE CONCAT('%', #{itemCode}, '%')
        </if>
        <if test="itemName != null and itemName != ''">
            AND ITEM_NM LIKE CONCAT('%', #{itemName}, '%')
        </if>
        ORDER BY ITEM_CD ASC
    </select>


    <select id="selectPrItemInfo" resultType="com.company.erp.pr.dto.PrItemDTO">
        SELECT ITEM_CD, ITEM_NM,ITEM_SPEC,UNIT_CD,RMK
        FROM MTGL
        WHERE DEL_FLAG='N'
        AND
        ITEM_CD IN
        <foreach collection="itemCdList" item="itemCd" open="(" separator="," close=")">
            #{itemCd}
        </foreach>
    </select>

    <select id="selectPrNum" parameterType="String" resultType="com.company.erp.pr.dto.PrHdDTO">
        SELECT 
            PR_NUM, 
            REG_USER_ID,
            PR_SUBJECT,
            DEPT_CD,
            PR_AMT,
            RMK,
            PC_TYPE,
            DEL_FLAG, 
            PROGRESS_CD,
            REG_DATE
        FROM PRHD
        WHERE PR_NUM = #{prNum}
    </select>

    <!-- 구매요청 헤더 수정 (구매요청명, 구매유형만) -->
    <update id="updatePrHd">
        UPDATE PRHD
        SET PR_SUBJECT = #{prSubject},
            PC_TYPE = (SELECT CODE FROM CODD
                      WHERE CODE_GROUP = 'PC_TYPE'
                      AND CODE_NAME = #{pcType}
                      AND USE_YN = 'Y'
                      LIMIT 1),
            MOD_DATE = NOW(),
            MOD_USER_ID = #{modUserId}
        WHERE PR_NUM = #{prNum}
        AND DEL_FLAG = 'N'
    </update>

    <!-- 구매요청 헤더 총액 업데이트 -->
    <update id="updatePrHdAmount">
        UPDATE PRHD
        SET PR_AMT = #{prAmt},
            MOD_DATE = NOW()
        WHERE PR_NUM = #{prNum}
        AND DEL_FLAG = 'N'
    </update>

    <!-- 구매요청 품목 수정 (수량, 단가, 금액) - 단일 품목 -->
    <update id="updatePrDt">
        UPDATE PRDT
        SET PR_QT = #{prQt},
            UNIT_PRC = #{unitPrc},
            PR_AMT = #{prAmt}
        WHERE PR_NUM = #{prNum}
        AND ITEM_CD = #{itemCd}
        AND DEL_FLAG = 'N'
    </update>

    <!-- 구매요청 헤더 삭제 -->
    <update id="deletePrHd">
        UPDATE PRHD
        SET DEL_FLAG = 'Y'
        WHERE PR_NUM = #{prNum}
        AND DEL_FLAG = 'N'
    </update>

    <update id="deletePrDt">
        UPDATE PRDT
        SET DEL_FLAG = 'Y'
        WHERE PR_NUM = #{prNum}
        AND DEL_FLAG = 'N'
    </update>


    <!-- 구매요청 현황 목록 조회 -->
    <select id="selectPrList" resultType="com.company.erp.pr.dto.PrListResponse">
        SELECT
            HD.PR_NUM      AS prNum,
            HD.PR_SUBJECT  AS prSubject,
            ST.CODE_NAME   AS progressCd,
            PT.CODE_NAME   AS pcType,
            U.USER_NM      AS requester,
            D.DEPT_NM      AS deptName,
            HD.REG_DATE    AS regDate,
            HD.PR_AMT      AS prAmt,
            HD.RMK         AS rmk
        FROM PRHD HD
        
        LEFT JOIN CODD ST
            ON ST.CODE_GROUP = 'PROGRESS_CD'
            AND ST.CODE = HD.PROGRESS_CD
            AND ST.USE_YN = 'Y'
        
        LEFT JOIN CODD PT
            ON PT.CODE_GROUP = 'PC_TYPE'
            AND PT.CODE = HD.PC_TYPE
            AND PT.USE_YN = 'Y'
        
        LEFT JOIN BY_USER U
            ON U.USER_ID = HD.REG_USER_ID
            AND U.DEL_FLAG = 'N'
        
        LEFT JOIN vw_dept_active D
            ON D.DEPT_CD = HD.DEPT_CD
        
        WHERE HD.DEL_FLAG = 'N'
        
        <!-- PR번호 검색 -->
        <if test="prNum != null and prNum != ''">
            AND HD.PR_NUM LIKE CONCAT('%', #{prNum}, '%')
        </if>
        
        <!-- 구매요청명 검색 -->
        <if test="prSubject != null and prSubject != ''">
            AND HD.PR_SUBJECT LIKE CONCAT('%', #{prSubject}, '%')
        </if>
        
        <!-- 요청자 검색 -->
        <if test="requester != null and requester != ''">
            AND U.USER_NM LIKE CONCAT('%', #{requester}, '%')
        </if>
        
        <!-- 부서 검색 (숫자 제외하고 비교) -->
        <if test="deptName != null and deptName != ''">
            AND REGEXP_REPLACE(D.DEPT_NM, '[0-9]', '') LIKE CONCAT('%', REGEXP_REPLACE(#{deptName}, '[0-9]', ''), '%')
        </if>
        
        <!-- 상태 검색 -->
        <if test="progressCd != null and progressCd != ''">
            AND ST.CODE_NAME = #{progressCd}
        </if>
        
        <!-- 요청일자 검색 -->
        <if test="requestDate != null and requestDate != ''">
            AND DATE(HD.REG_DATE) = #{requestDate}
        </if>
        
        <!-- 구매팀이 아닌 경우 본인이 작성한 구매요청만 조회 -->
        <if test="regUserId != null and regUserId != '' and (isBuyerDept == null or isBuyerDept == false)">
            AND HD.REG_USER_ID = #{regUserId}
        </if>

        
        ORDER BY HD.REG_DATE DESC
        <if test="offset != null and pageSize != null">
            LIMIT #{pageSize} OFFSET #{offset}
        </if>
    </select>

    <!-- 구매요청 현황 목록 총 개수 조회 -->
    <select id="selectPrListCount" resultType="int">
        SELECT COUNT(*)
        FROM PRHD HD
        
        LEFT JOIN CODD ST
            ON ST.CODE_GROUP = 'PROGRESS_CD'
            AND ST.CODE = HD.PROGRESS_CD
            AND ST.USE_YN = 'Y'
        
        LEFT JOIN CODD PT
            ON PT.CODE_GROUP = 'PC_TYPE'
            AND PT.CODE = HD.PC_TYPE
            AND PT.USE_YN = 'Y'
        
        LEFT JOIN BY_USER U
            ON U.USER_ID = HD.REG_USER_ID
            AND U.DEL_FLAG = 'N'
        
        LEFT JOIN vw_dept_active D
            ON D.DEPT_CD = HD.DEPT_CD
        
        WHERE HD.DEL_FLAG = 'N'
        
        <!-- PR번호 검색 -->
        <if test="prNum != null and prNum != ''">
            AND HD.PR_NUM LIKE CONCAT('%', #{prNum}, '%')
        </if>
        
        <!-- 구매요청명 검색 -->
        <if test="prSubject != null and prSubject != ''">
            AND HD.PR_SUBJECT LIKE CONCAT('%', #{prSubject}, '%')
        </if>
        
        <!-- 요청자 검색 -->
        <if test="requester != null and requester != ''">
            AND U.USER_NM LIKE CONCAT('%', #{requester}, '%')
        </if>
        
        <!-- 부서 검색 (숫자 제외하고 비교) -->
        <if test="deptName != null and deptName != ''">
            AND REGEXP_REPLACE(D.DEPT_NM, '[0-9]', '') LIKE CONCAT('%', REGEXP_REPLACE(#{deptName}, '[0-9]', ''), '%')
        </if>
        
        <!-- 진행상태 검색 -->
        <if test="progressCd != null and progressCd != ''">
            AND ST.CODE_NAME = #{progressCd}
        </if>
        
        <!-- 요청일자 검색 -->
        <if test="requestDate != null and requestDate != ''">
            AND DATE(HD.REG_DATE) = #{requestDate}
        </if>
        
        <!-- 구매팀이 아닌 경우 본인이 작성한 구매요청만 조회 -->
        <if test="regUserId != null and regUserId != '' and (isBuyerDept == null or isBuyerDept == false)">
            AND HD.REG_USER_ID = #{regUserId}
        </if>
    </select>

    <!-- 구매팀 여부 확인 (dept_role 테이블에서 BUYER 역할 확인) -->
    <select id="isBuyerDept" resultType="boolean">
        SELECT CASE 
            WHEN EXISTS (
                SELECT 1
                FROM dept_role dr
                WHERE dr.COM_TYPE = 'B'
                  AND dr.DEPT_CD = #{deptCd}
                  AND dr.ROLE = 'BUYER'
                  AND dr.USE_FLAG = 'Y'
            ) THEN 1
            ELSE 0
        END
    </select>

    <!-- 구매요청 상세 품목 목록 조회 -->
    <select id="selectPrDetail" resultType="com.company.erp.pr.dto.PrDtDTO">
        SELECT
            DT.PR_NUM      AS prNum,
            DT.REG_USER_ID AS regUserId,
            DT.DEL_FLAG    AS delFlag,
            DT.ITEM_CD     AS itemCd,
            DT.ITEM_DESC   AS itemDesc,
            DT.ITEM_SPEC   AS itemSpec,
            DT.UNIT_CD     AS unitCd,
            DT.PR_QT       AS prQt,
            DT.UNIT_PRC    AS unitPrc,
            DT.PR_AMT      AS prAmt,
            DT.DELY_DATE   AS delyDate,
            DT.RMK         AS rmk
        FROM PRDT DT
        WHERE DT.PR_NUM = #{prNum}
        AND DT.DEL_FLAG = 'N'
        ORDER BY DT.REG_DATE
    </select>

    <!-- CODE_NAME 조회  -->
    <select id="selectProgressCdName" resultType="String">
        SELECT CODE_NAME
        FROM CODD
        WHERE CODE_GROUP = 'PROGRESS_CD'
        AND CODE = #{progressCd}
        AND USE_YN = 'Y'
    </select>

    <!-- 구매요청 승인 -->
    <update id="approvePr">
        UPDATE PRHD
        SET PROGRESS_CD = (
            SELECT CODE FROM CODD
            WHERE CODE_GROUP = 'PROGRESS_CD'
            AND CODE_NAME = '승인'
            AND USE_YN = 'Y'
            LIMIT 1
        ),
        CTRL_USER_ID = #{userId},
        CTRL_DEPT_CD = #{deptCd}
        WHERE PR_NUM = #{prNum}
        AND DEL_FLAG = 'N'
    </update>

    <!-- 구매요청 반려 -->
    <update id="rejectPr">
        UPDATE PRHD
        SET PROGRESS_CD = (
            SELECT CODE FROM CODD
            WHERE CODE_GROUP = 'PROGRESS_CD'
            AND CODE_NAME = '반려'
            AND USE_YN = 'Y'
            LIMIT 1
        ),
        CTRL_USER_ID = #{userId},
        CTRL_DEPT_CD = #{deptCd}
        WHERE PR_NUM = #{prNum}
        AND DEL_FLAG = 'N'
    </update>

</mapper>