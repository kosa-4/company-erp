<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.company.erp.inventory.mapper.GoodsReceiptMapper">

    <!-- ========== 입고대상조회 ========== -->
    <!-- 발주전송(S) 상태이고, 미입고 수량이 남아있는 PO 목록 조회 (PO 기준 입고완료 여부 판단) -->
    <select id="selectPendingPOList" parameterType="map" resultType="com.company.erp.po.dto.PurchaseOrderDTO">
        SELECT h.PO_NUM AS poNo, h.PO_SUBJECT AS poName, h.PO_DATE AS poDate, h.RFQ_NUM AS rfqNo,
               h.PR_NUM AS prNo, h.CTRL_USER_ID AS ctrlUserName, v.VENDOR_NM AS vendorName
        FROM POHD h
        LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD
        WHERE h.PROGRESS_CD = 'S'
          AND h.CHECK_FLAG = 'Y'
          AND h.DEL_FLAG = 'N'
          AND COALESCE((
              SELECT SUM(d.GR_QT)
              FROM GRDT d
              INNER JOIN GRHD g ON d.GR_NUM = g.GR_NUM
              WHERE g.PO_NUM = h.PO_NUM
                AND d.STATUS_CD = 'N'
                AND d.DEL_FLAG = 'N'
                AND g.DEL_FLAG = 'N'
          ), 0) &lt; COALESCE((
              SELECT SUM(PO_QT)
              FROM PODT
              WHERE PO_NUM = h.PO_NUM AND DEL_FLAG = 'N'
          ), 0)
        <if test="poNo != null and poNo != ''"> AND h.PO_NUM LIKE CONCAT('%', #{poNo}, '%') </if>
        <if test="vendorName != null and vendorName != ''"> AND v.VENDOR_NM LIKE CONCAT('%', #{vendorName}, '%') </if>
        <if test="startDate != null and startDate != ''"> AND h.PO_DATE &gt;= #{startDate} </if>
        <if test="endDate != null and endDate != ''"> AND h.PO_DATE &lt;= #{endDate} </if>
        ORDER BY h.PO_DATE DESC
    </select>

    <!-- 발주번호로 기존 GR 정보 조회 (GR번호, 저장위치) - 중복채번 방지용 -->
    <select id="selectExistingGrByPoNo" parameterType="String" resultType="map"> SELECT h.GR_NUM AS
        grNo, d.WH_CD AS warehouseCode FROM GRHD h INNER JOIN GRDT d ON h.GR_NUM = d.GR_NUM WHERE
        h.PO_NUM = #{poNo} AND h.PROGRESS_CD != 'GRX' AND h.DEL_FLAG = 'N' AND d.DEL_FLAG = 'N' AND
        d.STATUS_CD = 'N' LIMIT 1 </select>

    <!-- ========== 입고현황 ========== -->
    <!-- 입고 목록 조회 -->
    <select id="selectList" parameterType="map"
        resultType="com.company.erp.inventory.dto.GoodsReceiptDTO"> SELECT h.GR_NUM AS grNo,
        h.PO_NUM AS poNo, h.GR_DATE AS grDate, h.GR_AMT AS totalAmount, h.PROGRESS_CD AS status,
        h.RMK AS remark, v.VENDOR_NM AS vendorName, ( SELECT bu.USER_NM FROM BY_USER bu WHERE
        bu.USER_ID = h.CTRL_USER_ID LIMIT 1 ) AS ctrlUserName FROM GRHD h LEFT JOIN POHD p ON
        h.PO_NUM = p.PO_NUM LEFT JOIN VNGL v ON p.VENDOR_CD = v.VENDOR_CD WHERE h.DEL_FLAG = 'N' <if
            test="grNo != null and grNo != ''"> AND h.GR_NUM LIKE CONCAT('%', #{grNo}, '%') </if>
        <if
            test="vendorName != null and vendorName != ''"> AND v.VENDOR_NM LIKE CONCAT('%',
        #{vendorName}, '%') </if>
        <if test="status != null and status != ''"> AND h.PROGRESS_CD =
        #{status} </if>
        <if test="startDate != null and startDate != ''"> AND h.GR_DATE &gt;=
        #{startDate} </if>
        <if test="endDate != null and endDate != ''"> AND h.GR_DATE &lt;=
        #{endDate} </if> ORDER BY h.REG_DATE DESC </select>

    <!-- 입고 헤더 단건 조회 -->
    <select id="selectHeader" parameterType="String"
        resultType="com.company.erp.inventory.dto.GoodsReceiptDTO"> SELECT h.GR_NUM AS grNo,
        h.PO_NUM AS poNo, h.GR_DATE AS grDate, h.GR_AMT AS totalAmount, h.PROGRESS_CD AS status,
        h.RMK AS remark, v.VENDOR_NM AS vendorName, ( SELECT bu.USER_NM FROM BY_USER bu WHERE
        bu.USER_ID = h.CTRL_USER_ID LIMIT 1 ) AS ctrlUserName FROM GRHD h LEFT JOIN POHD p ON
        h.PO_NUM = p.PO_NUM LEFT JOIN VNGL v ON p.VENDOR_CD = v.VENDOR_CD WHERE h.GR_NUM = #{grNo}
        AND h.DEL_FLAG = 'N' </select>

    <!-- 입고 상세 품목 목록 조회 -->
    <select id="selectItems" parameterType="String"
        resultType="com.company.erp.inventory.dto.GoodsReceiptItemDTO"> SELECT d.GR_NUM AS grNo,
        d.ITEM_CD AS itemCode, d.ITEM_DESC AS itemDesc, d.ITEM_SPEC AS itemSpec, d.UNIT_CD AS
        unitCode, d.GR_QT AS grQuantity, d.GR_AMT AS grAmount, d.VENDOR_CD AS vendorCode,
        v.VENDOR_NM AS vendorName, d.CTRL_USER_ID AS ctrlUserId, d.WH_CD AS warehouseCode, d.GR_DATE
        AS grDate, d.RMK AS remark, d.STATUS_CD AS statusCode, d.CANCLE_RMK AS cancelRemark,
        pd.UNIT_PRC AS unitPrice, pd.PO_QT AS orderQty, pd.PO_AMT AS orderAmount, ( SELECT
        COALESCE(SUM(gd2.GR_QT), 0) FROM GRDT gd2 JOIN GRHD gh2 ON gd2.GR_NUM = gh2.GR_NUM WHERE
        gh2.PO_NUM = h.PO_NUM AND gd2.ITEM_CD = d.ITEM_CD AND gd2.STATUS_CD = 'N' AND gd2.DEL_FLAG =
        'N' ) AS accumulatedQty FROM GRDT d INNER JOIN GRHD h ON d.GR_NUM = h.GR_NUM LEFT JOIN PODT
        pd ON h.PO_NUM = pd.PO_NUM AND d.ITEM_CD = pd.ITEM_CD LEFT JOIN VNGL v ON d.VENDOR_CD =
        v.VENDOR_CD WHERE d.GR_NUM = #{grNo} AND d.DEL_FLAG = 'N' </select>

    <!-- ========== 입고처리 ========== -->
    <!-- PO 번호와 품목 코드로 기존 GR 번호 조회 (PO, Item 기준 유일한 활성 GR 찾기) -->
    <select id="selectExistingGrByPoAndItem" parameterType="map" resultType="String"> SELECT
        h.GR_NUM FROM GRHD h INNER JOIN GRDT d ON h.GR_NUM = d.GR_NUM WHERE h.PO_NUM = #{poNo} AND
        d.ITEM_CD = #{itemCode} AND h.DEL_FLAG = 'N' AND d.DEL_FLAG = 'N' AND d.STATUS_CD = 'N' AND
        h.PROGRESS_CD != 'GRX' LIMIT 1 </select>

    <!-- PO 번호와 품목 코드로 기존 GR의 저장위치 조회 (품목별 입고번호 기준 저장위치 확인용) -->
    <select id="selectWarehouseByPoAndItem" parameterType="map" resultType="String">
        SELECT d.WH_CD
        FROM GRHD h
        INNER JOIN GRDT d ON h.GR_NUM = d.GR_NUM
        WHERE h.PO_NUM = #{poNo}
          AND d.ITEM_CD = #{itemCode}
          AND h.PROGRESS_CD != 'GRX'
          AND h.DEL_FLAG = 'N'
          AND d.DEL_FLAG = 'N'
          AND d.STATUS_CD = 'N'
        LIMIT 1
    </select>

    <!-- 입고 헤더 등록 -->
    <insert id="insertHeader"> INSERT INTO GRHD ( GR_NUM, PO_NUM, GR_DATE, GR_AMT, PROGRESS_CD,
        CTRL_USER_ID, CTRL_DEPT_CD, RMK, REG_DATE, REG_USER_ID, DEL_FLAG ) VALUES ( #{dto.grNo},
        #{dto.poNo}, #{dto.grDate}, #{dto.totalAmount}, #{dto.status}, #{regUserId}, #{ctrlDeptCd},
        #{dto.remark}, NOW(), #{regUserId}, 'N' ) </insert>

    <!-- 입고 상세 품목 등록 -->
    <insert id="insertItem"> INSERT INTO GRDT ( GR_NUM, ITEM_CD, ITEM_DESC, ITEM_SPEC, UNIT_CD,
        GR_QT, GR_AMT, VENDOR_CD, CTRL_USER_ID, CTRL_DEPT_CD, WH_CD, GR_DATE, RMK, STATUS_CD,
        REG_DATE, REG_USER_ID, DEL_FLAG ) VALUES ( #{item.grNo}, #{item.itemCode}, #{item.itemDesc},
        #{item.itemSpec}, #{item.unitCode}, #{item.grQuantity}, #{item.grAmount},
        #{item.vendorCode}, #{item.ctrlUserId}, #{item.ctrlDeptCd}, #{item.warehouseCode},
        #{item.grDate}, #{item.remark}, #{item.statusCode}, NOW(), #{item.ctrlUserId}, 'N' ) </insert>

    <!-- ========== 입고조정 ========== -->
    <!-- 상세 품목 수정 (입고수량, 저장위치만) -->
    <update id="updateItem"> UPDATE GRDT SET GR_QT = #{item.grQuantity}, GR_AMT = #{item.grAmount},
        WH_CD = #{item.warehouseCode}, MOD_DATE = NOW(), MOD_USER_ID = #{modUserId} WHERE GR_NUM =
        #{item.grNo} AND ITEM_CD = #{item.itemCode} </update>

    <!-- 상세 품목 취소 처리 -->
    <update id="cancelItem"> UPDATE GRDT SET STATUS_CD = 'C', CANCLE_RMK = #{cancelRemark}, MOD_DATE
        = NOW(), MOD_USER_ID = #{modUserId} WHERE GR_NUM = #{grNo} AND ITEM_CD = #{itemCode} </update>

    <!-- 헤더 상태 업데이트 -->
    <update id="updateHeaderStatus"> UPDATE GRHD SET PROGRESS_CD = #{status}, MOD_DATE = NOW(),
        MOD_USER_ID = #{modUserId} WHERE GR_NUM = #{grNo} </update>

    <!-- 특정 PO에 연결된 모든 입고 헤더 상태 일괄 업데이트 (취소 제외) -->
    <update id="updateAllHeadersStatusByPO"> UPDATE GRHD SET PROGRESS_CD = #{status}, MOD_DATE =
        NOW(), MOD_USER_ID = #{modUserId} WHERE PO_NUM = #{poNo} AND PROGRESS_CD != 'GRX' AND
        DEL_FLAG = 'N' </update>

    <!-- ========== 상태 계산용 ========== -->
    <!-- 특정 PO의 누적 입고수량 조회 (정상 상태만) -->
    <select id="selectAccumulatedQty" parameterType="String" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(d.GR_QT), 0) FROM GRDT d INNER JOIN GRHD h ON d.GR_NUM = h.GR_NUM WHERE
        h.PO_NUM = #{poNo} AND d.STATUS_CD = 'N' AND d.DEL_FLAG = 'N' AND h.DEL_FLAG = 'N' </select>

    <!-- 특정 PO의 발주수량 합계 조회 -->
    <select id="selectOrderQty" parameterType="String" resultType="java.math.BigDecimal"> SELECT
        COALESCE(SUM(PO_QT), 0) FROM PODT WHERE PO_NUM = #{poNo} AND DEL_FLAG = 'N' </select>

    <!-- 특정 GR의 입고수량 합계 조회 (정상 상태만) -->
    <select id="selectGrAccumulatedQty" parameterType="String" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(d.GR_QT), 0)
        FROM GRDT d
        WHERE d.GR_NUM = #{grNo}
          AND d.STATUS_CD = 'N'
          AND d.DEL_FLAG = 'N'
    </select>

    <!-- 특정 GR에 속한 품목들의 발주수량 합계 조회 -->
    <select id="selectGrOrderQty" parameterType="String" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(p.PO_QT), 0)
        FROM GRDT d
        INNER JOIN GRHD h ON d.GR_NUM = h.GR_NUM
        INNER JOIN PODT p ON d.ITEM_CD = p.ITEM_CD AND h.PO_NUM = p.PO_NUM
        WHERE d.GR_NUM = #{grNo}
          AND p.DEL_FLAG = 'N'
          AND d.DEL_FLAG = 'N'
    </select>

    <!-- 특정 GR의 모든 DT가 취소 상태인지 확인 -->
    <select id="isAllItemsCancelled" parameterType="String" resultType="boolean"> SELECT CASE WHEN
        COUNT(*) = 0 THEN TRUE WHEN SUM( CASE WHEN STATUS_CD = 'N' THEN 1 ELSE 0 END ) = 0 THEN TRUE
        ELSE FALSE END FROM GRDT WHERE GR_NUM = #{grNo} AND DEL_FLAG = 'N' </select>

    <!-- GR 번호로 PO 번호 조회 -->
    <select id="selectPoNoByGrNo" parameterType="String" resultType="String"> SELECT PO_NUM FROM
        GRHD WHERE GR_NUM = #{grNo} AND DEL_FLAG = 'N' </select>

    <!-- 특정 PO의 품목별 입고된 총 수량 조회 (부분입고 지원) -->
    <select id="getReceivedQuantity" resultType="java.lang.Integer"> SELECT COALESCE(SUM(d.GR_QT),
        0) FROM GRDT d INNER JOIN GRHD h ON d.GR_NUM = h.GR_NUM WHERE h.PO_NUM = #{poNo} AND
        d.ITEM_CD = #{itemCode} AND d.STATUS_CD = 'N' AND d.DEL_FLAG = 'N' AND h.DEL_FLAG = 'N' AND
        h.PROGRESS_CD != 'GRX' </select>

</mapper>