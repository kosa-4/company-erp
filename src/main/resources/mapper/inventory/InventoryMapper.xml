<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.company.erp.inventory.mapper.InventoryMapper">

    <!-- ========== 입고대상 조회 ========== -->
    <!-- 
        조건:
        1. POHD.PROGRESS_CD = 'S' (발주전송)
        2. 입고테이블에 없는 PO 또는 부분입고 상태
    -->
    <select id="selectReceivingTargets" parameterType="Map" 
            resultType="com.company.erp.inventory.dto.ReceivingTargetDTO">
        SELECT 
            h.PO_NUM       AS poNo,
            h.PO_SUBJECT   AS poName,
            u.USER_NM      AS buyer,
            h.PO_DATE      AS poDate,
            h.VENDOR_CD    AS vendorCode,
            v.VENDOR_NM    AS vendorName,
            d.ITEM_CD      AS itemCode,
            d.ITEM_DESC    AS itemName,
            d.ITEM_SPEC    AS spec,
            d.UNIT_CD      AS unit,
            d.UNIT_PRC     AS unitPrice,
            d.PO_QT        AS orderQuantity,
            d.WH_CD        AS storageLocation,
            d.PO_AMT       AS amount
        FROM PODT d
        INNER JOIN POHD h ON d.PO_NUM = h.PO_NUM
        LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD
        LEFT JOIN by_user u ON h.CTRL_USER_ID = u.USER_ID
        WHERE h.DEL_FLAG = 'N'
          AND d.DEL_FLAG = 'N'
          AND h.PROGRESS_CD = 'S'
          AND (
              <!-- 미입고: 입고테이블에 없는 경우 -->
              NOT EXISTS (
                  SELECT 1 
                  FROM GRDT g
                  INNER JOIN GRHD gh ON g.GR_NUM = gh.GR_NUM
                  WHERE gh.PO_NUM = d.PO_NUM 
                    AND g.ITEM_CD = d.ITEM_CD 
                    AND g.DEL_FLAG = 'N'
                    AND gh.DEL_FLAG = 'N'
              )
              OR
              <!-- 부분입고: 누적 입고수량 < 발주수량 -->
              EXISTS (
                  SELECT 1 
                  FROM GRDT g
                  INNER JOIN GRHD gh ON g.GR_NUM = gh.GR_NUM
                  WHERE gh.PO_NUM = d.PO_NUM
                    AND g.ITEM_CD = d.ITEM_CD
                    AND g.DEL_FLAG = 'N'
                    AND gh.DEL_FLAG = 'N'
                    AND gh.PROGRESS_CD = 'GRP'
                  GROUP BY gh.PO_NUM, g.ITEM_CD
                  HAVING SUM(g.GR_QT) &lt; d.PO_QT
              )
          )
        <if test="poNo != null and poNo != ''">
            AND h.PO_NUM LIKE CONCAT('%', #{poNo}, '%')
        </if>
        <if test="poName != null and poName != ''">
            AND h.PO_SUBJECT LIKE CONCAT('%', #{poName}, '%')
        </if>
        <if test="buyer != null and buyer != ''">
            AND u.USER_NM LIKE CONCAT('%', #{buyer}, '%')
        </if>
        <if test="vendor != null and vendor != ''">
            AND v.VENDOR_NM LIKE CONCAT('%', #{vendor}, '%')
        </if>
        <if test="item != null and item != ''">
            AND (d.ITEM_CD LIKE CONCAT('%', #{item}, '%') 
                 OR d.ITEM_DESC LIKE CONCAT('%', #{item}, '%'))
        </if>
        <if test="startDate != null and startDate != ''">
            AND h.PO_DATE &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND h.PO_DATE &lt;= #{endDate}
        </if>
        ORDER BY h.PO_DATE DESC, h.PO_NUM DESC
    </select>


    <!-- ========== 입고 헤더 목록 조회 ========== -->
    <!-- CODD JOIN으로 코드명 조회 -->
    <select id="selectGrHeaderList" parameterType="Map" 
            resultType="com.company.erp.inventory.dto.GrHeaderDTO">
        SELECT 
            h.GR_NUM       AS grNo,
            h.PO_NUM       AS poNo,
            h.GR_DATE      AS documentDate,
            h.GR_DATE      AS postingDate,
            h.GR_AMT       AS totalAmount,
            c.CODE_NAME    AS status,
            h.RMK          AS remark,
            DATE_FORMAT(h.REG_DATE, '%Y-%m-%d %H:%i:%s') AS createdAt,
            h.REG_USER_ID  AS createdBy,
            h.CTRL_USER_ID AS receiverId,
            u.USER_NM      AS receiverName
        FROM GRHD h
        LEFT JOIN CODD c ON c.CODE_GROUP = 'PROGRESS_CD' 
                        AND c.CODE = h.PROGRESS_CD 
                        AND c.USE_YN = 'Y'
        LEFT JOIN by_user u ON h.CTRL_USER_ID = u.USER_ID
        WHERE h.DEL_FLAG = 'N'
        <if test="grNo != null and grNo != ''">
            AND h.GR_NUM LIKE CONCAT('%', #{grNo}, '%')
        </if>
        <if test="receiver != null and receiver != ''">
            AND u.USER_NM LIKE CONCAT('%', #{receiver}, '%')
        </if>
        <if test="vendor != null and vendor != ''">
            AND EXISTS (
                SELECT 1 
                FROM GRDT d
                INNER JOIN VNGL v ON d.VENDOR_CD = v.VENDOR_CD
                WHERE d.GR_NUM = h.GR_NUM
                  AND v.VENDOR_NM LIKE CONCAT('%', #{vendor}, '%')
            )
        </if>
        <if test="item != null and item != ''">
            AND EXISTS (
                SELECT 1 
                FROM GRDT d
                WHERE d.GR_NUM = h.GR_NUM
                  AND (d.ITEM_CD LIKE CONCAT('%', #{item}, '%') 
                       OR d.ITEM_DESC LIKE CONCAT('%', #{item}, '%'))
            )
        </if>
        <if test="startDate != null and startDate != ''">
            AND h.GR_DATE &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND h.GR_DATE &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND c.CODE_NAME = #{status}
        </if>
        ORDER BY h.REG_DATE DESC
    </select>


    <!-- ========== 입고 헤더 상세 조회 ========== -->
    <select id="selectGrHeader" parameterType="String" 
            resultType="com.company.erp.inventory.dto.GrHeaderDTO">
        SELECT 
            h.GR_NUM       AS grNo,
            h.PO_NUM       AS poNo,
            h.GR_DATE      AS documentDate,
            h.GR_DATE      AS postingDate,
            h.GR_AMT       AS totalAmount,
            c.CODE_NAME    AS status,
            h.RMK          AS remark,
            DATE_FORMAT(h.REG_DATE, '%Y-%m-%d %H:%i:%s') AS createdAt,
            h.REG_USER_ID  AS createdBy,
            h.CTRL_USER_ID AS receiverId,
            u.USER_NM      AS receiverName
        FROM GRHD h
        LEFT JOIN CODD c ON c.CODE_GROUP = 'PROGRESS_CD' 
                        AND c.CODE = h.PROGRESS_CD 
                        AND c.USE_YN = 'Y'
        LEFT JOIN by_user u ON h.CTRL_USER_ID = u.USER_ID
        WHERE h.GR_NUM = #{grNo} 
          AND h.DEL_FLAG = 'N'
    </select>


    <!-- ========== 입고 상세 목록 조회 ========== -->
    <!-- 주의: GRDT에 PO_NUM 컬럼이 없으므로 GRHD를 통해 조회 -->
    <select id="selectGrDetails" parameterType="String" 
            resultType="com.company.erp.inventory.dto.GrDetailDTO">
        SELECT 
            d.GR_NUM       AS grNo,
            ROW_NUMBER() OVER (PARTITION BY d.GR_NUM ORDER BY d.ITEM_CD) AS lineNo,
            h.PO_NUM       AS poNo,
            d.ITEM_CD      AS itemCode,
            d.ITEM_DESC    AS itemName,
            d.ITEM_SPEC    AS spec,
            d.UNIT_CD      AS unit,
            <!-- 단가 계산: 입고금액 / 입고수량 -->
            CASE 
                WHEN d.GR_QT &gt; 0 THEN d.GR_AMT / d.GR_QT 
                ELSE 0 
            END AS unitPrice,
            <!-- 발주 정보 -->
            po.PO_QT       AS orderQuantity,
            po.PO_AMT      AS orderAmount,
            <!-- 입고 정보 -->
            d.GR_QT        AS receivedQuantity,
            d.GR_AMT       AS receivedAmount,
            <!-- 누적 입고수량 계산 (GRHD의 PO_NUM 기준) -->
            (
                SELECT COALESCE(SUM(g2.GR_QT), 0) 
                FROM GRDT g2
                INNER JOIN GRHD h2 ON g2.GR_NUM = h2.GR_NUM
                WHERE h2.PO_NUM = h.PO_NUM 
                  AND g2.ITEM_CD = d.ITEM_CD 
                  AND g2.DEL_FLAG = 'N'
                  AND h2.DEL_FLAG = 'N'
            ) AS cumulativeQuantity,
            <!-- 협력사 정보 -->
            d.VENDOR_CD    AS vendorCode,
            v.VENDOR_NM    AS vendorName,
            <!-- 담당자 정보 -->
            d.CTRL_USER_ID AS receiverId,
            u.USER_NM      AS receiverName,
            <!-- 기타 -->
            d.WH_CD        AS storageLocation,
            d.GR_DATE      AS receivedDateTime,
            CASE 
                WHEN d.DEL_FLAG = 'N' THEN 'NORMAL' 
                ELSE 'CANCELED' 
            END AS status,
            d.RMK          AS remark
        FROM GRDT d
        INNER JOIN GRHD h ON d.GR_NUM = h.GR_NUM
        LEFT JOIN PODT po ON h.PO_NUM = po.PO_NUM
                         AND d.ITEM_CD = po.ITEM_CD 
                         AND po.DEL_FLAG = 'N'
        LEFT JOIN VNGL v ON d.VENDOR_CD = v.VENDOR_CD
        LEFT JOIN by_user u ON d.CTRL_USER_ID = u.USER_ID
        WHERE d.GR_NUM = #{grNo} 
          AND d.DEL_FLAG = 'N'
          AND h.DEL_FLAG = 'N'
        ORDER BY d.ITEM_CD
    </select>


    <!-- ========== 입고 헤더 등록 ========== -->
    <insert id="insertGrHeader" parameterType="Map">
        INSERT INTO GRHD (
            GR_NUM, 
            PO_NUM, 
            GR_DATE, 
            GR_AMT, 
            PROGRESS_CD,
            CTRL_USER_ID, 
            RMK, 
            REG_DATE, 
            REG_USER_ID, 
            DEL_FLAG
        ) VALUES (
            #{dto.grNo}, 
            #{dto.poNo}, 
            #{dto.documentDate}, 
            #{dto.totalAmount},
            #{dto.status},
            #{dto.receiverId},
            #{dto.remark}, 
            NOW(), 
            #{regUserId}, 
            'N'
        )
    </insert>


    <!-- ========== 입고 상세 등록 ========== -->
    <insert id="insertGrDetail" parameterType="Map">
        INSERT INTO GRDT (
            GR_NUM, 
            ITEM_CD, 
            ITEM_DESC, 
            ITEM_SPEC, 
            UNIT_CD,
            GR_QT, 
            GR_AMT, 
            VENDOR_CD, 
            CTRL_USER_ID, 
            WH_CD,
            GR_DATE, 
            RMK, 
            REG_DATE, 
            REG_USER_ID, 
            DEL_FLAG
        ) VALUES (
            #{detail.grNo}, 
            #{detail.itemCode}, 
            #{detail.itemName}, 
            #{detail.spec},
            #{detail.unit}, 
            #{detail.receivedQuantity}, 
            #{detail.receivedAmount},
            #{detail.vendorCode}, 
            #{detail.receiverId}, 
            #{detail.storageLocation},
            #{detail.receivedDateTime}, 
            #{detail.remark}, 
            NOW(), 
            #{regUserId}, 
            'N'
        )
    </insert>


    <!-- ========== 입고 헤더 수정 ========== -->
    <update id="updateGrHeader" parameterType="Map">
        UPDATE GRHD 
        SET 
            GR_DATE     = #{dto.documentDate},
            GR_AMT      = #{dto.totalAmount},
            PROGRESS_CD = #{dto.status},
            RMK         = #{dto.remark},
            MOD_DATE    = NOW(),
            MOD_USER_ID = #{modUserId}
        WHERE GR_NUM = #{dto.grNo} 
          AND DEL_FLAG = 'N'
    </update>


    <!-- ========== 입고 상세 수정 ========== -->
    <update id="updateGrDetail" parameterType="Map">
        UPDATE GRDT 
        SET 
            GR_QT       = #{detail.receivedQuantity},
            GR_AMT      = #{detail.receivedAmount},
            WH_CD       = #{detail.storageLocation},
            GR_DATE     = #{detail.receivedDateTime},
            RMK         = #{detail.remark},
            MOD_DATE    = NOW(),
            MOD_USER_ID = #{modUserId}
        WHERE GR_NUM = #{detail.grNo} 
          AND ITEM_CD = #{detail.itemCode}
          AND DEL_FLAG = 'N'
    </update>


    <!-- ========== 입고 상세 부분 수정 (입고조정용) ========== -->
    <!-- 수정 가능 필드: 입고수량, 저장위치만 -->
    <update id="updateGrDetailPartial" parameterType="Map">
        UPDATE GRDT 
        SET 
            GR_QT       = #{detail.receivedQuantity},
            GR_AMT      = #{detail.receivedAmount},
            WH_CD       = #{detail.storageLocation},
            RMK         = #{detail.remark},
            MOD_DATE    = NOW(),
            MOD_USER_ID = #{modUserId}
        WHERE GR_NUM = #{detail.grNo}
          AND ITEM_CD = #{detail.itemCode}
          AND DEL_FLAG = 'N'
    </update>


    <!-- ========== 입고 취소 ========== -->
    <update id="cancelGr" parameterType="Map">
        UPDATE GRHD 
        SET 
            PROGRESS_CD = 'GRN',
            MOD_DATE    = NOW(),
            MOD_USER_ID = #{modUserId}
        WHERE GR_NUM = #{grNo} 
          AND DEL_FLAG = 'N'
    </update>


    <!-- ========== 입고 헤더 삭제 (논리 삭제) ========== -->
    <update id="deleteGrHeader">
        UPDATE GRHD 
        SET DEL_FLAG = 'Y' 
        WHERE GR_NUM = #{grNo}
    </update>


    <!-- ========== 입고 상세 삭제 (논리 삭제) ========== -->
    <update id="deleteGrDetails">
        UPDATE GRDT 
        SET DEL_FLAG = 'Y' 
        WHERE GR_NUM = #{grNo}
    </update>

</mapper>