<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.company.erp.master.item.mapper.ItemMapper">
    <!--조회-->
    <select id="selectItemList" parameterType="com.company.erp.master.item.dto.ItemSearchDto" resultType="com.company.erp.master.item.dto.ItemDetailDto">
        SELECT
            GL.ITEM_CD AS itemCode,
            GL.ITEM_NM AS itemName,
            IFNULL(CA.ITEM_CLS_NM, '없음') AS itemType,
            GL.ITEM_SPEC AS spec,
            GL.UNIT_CD AS unit,
            GL.MAKER_NM AS manufacturerName,
            GL.REG_DATE AS createdAt
        FROM
            MTGL GL
        LEFT JOIN
            MTGC GC
        ON
            GL.ITEM_CD = GC.ITEM_CD
        LEFT JOIN
            MTCA CA
        ON
            GC.ITEM_CLS = CA.ITEM_CLS
        <where>
            GL.DEL_FLAG = 'N'
            <if test="itemCode != null and itemCode != ''">
                AND GL.ITEM_CD LIKE CONCAT('%', #{itemCode}, '%')
            </if>
            <if test="itemName != null and itemName != ''">
                AND GL.ITEM_NM LIKE CONCAT('%', #{itemName}, '%')
            </if>
            <if test="useYn != null and useYn != ''">
                AND GL.USE_FLAG = #{useYn}
            </if>
            <if test="date != null">
                AND REG_DATE BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="manufacturerName != null and manufacturerName != ''">
                AND GL.MAKER_NM LIKE CONCAT('%', #{manufacturerName}, '%')
            </if>
        </where>
        ORDER BY
            GL.REG_DATE DESC
        LIMIT #{pageSize}
        OFFSET #{offset} <!--알아서 get으로 호출-->
    </select>

    <!--중복 검사-->
    <select id="existsByNameAndSpec" parameterType="com.company.erp.master.item.dto.ItemDetailDto" resultType="boolean">
        select
            COUNT(*)
        from
            MTGL
        where
            ITEM_NM = #{itemName}
        AND
            ITEM_SPEC = #{spec}
        AND
            DEL_FLAG = 'N'
    </select>

    <!--개수-->
    <select id="countItemList" parameterType="com.company.erp.master.item.dto.ItemSearchDto" resultType="int">
        SELECT
            COUNT(*) AS item_count
        FROM
            MTGL
        <where>
            DEL_FLAG = 'N'
            <if test="itemCode != null and itemCode != ''">
                AND ITEM_CD LIKE CONCAT('%', #{itemCode}, '%')
            </if>
            <if test="itemName != null and itemName != ''">
                AND ITEM_NM LIKE CONCAT('%', #{itemName}, '%')
            </if>
            <if test="useYn != null and useYn != ''">
                AND USE_FLAG = #{useYn}
            </if>
            <if test="date != null">
                AND REG_DATE BETWEEN #{startDate} AND #{endDate}
            </if>
            <if test="manufacturerName != null and manufacturerName != ''">
                AND MAKER_NM LIKE CONCAT('%', #{manufacturerName}, '%')
            </if>
        </where>
    </select>

    <!--상세 품목 조회-->
    <select id="selectItemByCode" parameterType="String" resultType="com.company.erp.master.item.dto.ItemDetailDto">
        SELECT
            GL.ITEM_CD AS itemCode,
            GL.ITEM_NM AS itemName,
            GL.ITEM_NM_ENG AS itemNameEn,
            IFNULL(CA_TYPE.ITEM_CLS_NM, '없음') AS itemType,
            IFNULL(CA_L.ITEM_CLS_NM, '없음') AS categoryL,
            IFNULL(CA_M.ITEM_CLS_NM, '없음') AS categoryM,
            IFNULL(CA_S.ITEM_CLS_NM, '없음') AS categoryS,
            CA_TYPE.ITEM_CLS    AS itemTypeCode,
            CA_L.ITEM_CLS       AS categoryLCode,
            CA_M.ITEM_CLS       AS categoryMCode,
            CA_S.ITEM_CLS       AS categorySCode,
            GL.ITEM_SPEC AS spec,
            GL.UNIT_CD AS unit,
            GL.MAKER_NM AS manufacturerName,
            GL.MODEL_NO AS modelNo,
            GL.USE_FLAG AS useYn,
            GL.RMK AS remark,
            GL.REG_DATE AS createdAt,
            GL.REG_USER_ID AS createdBy
        FROM
            MTGL GL
        LEFT JOIN <!--카테고리가 삭제되더라도 표시되기 위해서-->
            MTGC GC
        ON
            GL.ITEM_CD = GC.ITEM_CD
        LEFT JOIN
            MTCA CA_TYPE
        ON
            GC.ITEM_CLS = CA_TYPE.ITEM_CLS
        LEFT JOIN
            MTCA CA_L
        ON
            GC.ITEM_CLS1 = CA_L.ITEM_CLS
        LEFT JOIN
            MTCA CA_M
        ON
            GC.ITEM_CLS2 = CA_M.ITEM_CLS
        LEFT JOIN
            MTCA CA_S
        ON
            GC.ITEM_CLS3 = CA_S.ITEM_CLS
        WHERE
            GL.ITEM_CD = #{code}
    </select>

    <!--품목 마스터 테이블 저장-->
    <insert id="insertItemMTGL" parameterType="com.company.erp.master.item.dto.ItemDetailDto">
        INSERT INTO
            MTGL(
                ITEM_CD,
                REG_DATE,
                REG_USER_ID,
                MOD_DATE,
                MOD_USER_ID,
                DEL_FLAG,
                USE_FLAG,
                USE_RMK,
                ITEM_NM,
                ITEM_NM_ENG,
                ITEM_SPEC,
                MAKER_NM,
                MODEL_NO,
                PROGRESS_CD,
                RMK,
                UNIT_CD
            )
            VALUES(
                #{itemCode},
                #{createdAt},
                #{createdBy},
                #{modifiedAt},
                #{modifiedBy},
                'N',
                'Y',
                #{stopReason},
                #{itemName},
                #{itemNameEn},
                #{spec},
                #{manufacturerName},
                #{modelNo},
                #{status},
                #{remark},
                #{unit}
            )
    </insert>

    <!--품목 분류 테이블 저장-->
    <insert id="insertItemMTGC" parameterType="com.company.erp.master.item.dto.ItemDetailDto">
        INSERT INTO
            MTGC(
                ITEM_CD,
                REG_DATE,
                REG_USER_ID,
                MOD_DATE,
                MOD_USER_ID,
                DEL_FLAG,
                ITEM_CLS,
                ITEM_CLS1,
                ITEM_CLS2,
                ITEM_CLS3,
                USE_FLAG
            )
        VALUES(
                #{itemCode},
                #{createdAt},
                #{createdBy},
                NULL,
                NULL,
                'N',
                #{itemType},
                #{categoryL},
                #{categoryM},
                #{categoryS},
                'Y'
            )
    </insert>

    <!--품목 수정-->
    <update id="updateItem" parameterType="com.company.erp.master.item.dto.ItemDetailDto">
        UPDATE
        MTGL
        <set>
            MOD_DATE = #{modifiedAt},
            MOD_USER_ID = #{modifiedBy},
            <if test="itemName != null">
                ITEM_NM = #{itemName},
            </if>
            <if test="itemNameEn != null">
                ITEM_NM_ENG = #{itemNameEn},
            </if>
            <if test="remark != null">
                RMK = #{remark},
            </if>
            <if test="useYn != null">
                USE_FLAG = #{useYn}
            </if>
        </set>
        WHERE
            ITEM_CD = #{itemCode}

    </update>
</mapper>