<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.company.erp.master.vendoruser.mapper.VendorUserMapper">
    <!--협력사 유저 정보 전체 조회-->
    <select id="selectVendorUserList" parameterType="com.company.erp.master.vendoruser.dto.VendorUserSearchDto" resultType="com.company.erp.master.vendoruser.dto.VendorUserListDto">
        SELECT
            U.askUserNum,
            U.vendorCode,
            V.VENDOR_NM AS vendorName,
            U.userId,
            U.userName,
            U.phone,
            U.email,
            U.status,
            U.createdAt,
            U.blockFlag,
            U.password,
            U.delFlag
        FROM (
            <!--테이블 결합-->
            SELECT
                ASK_USER_NUM AS askUserNum,
                VENDOR_CD AS vendorCode,
                USER_ID AS userId,
                USER_NM AS userName,
                TEL_NO AS phone,
                EMAIL AS email,
                PROGRESS_CD AS status,
                REG_DATE AS createdAt,
                'N' AS blockFlag,
                PASSWORD AS password,
                DEL_FLAG AS delFlag
            FROM
                VNCH_US
            WHERE
                PROGRESS_CD IN ('N', 'C', 'R')

            UNION ALL

            SELECT
                NULL AS askUserNum,
                VENDOR_CD AS vendorCode,
                USER_ID AS userId,
                USER_NM AS userName,
                TEL_NUM AS phone,
                EMAIL AS email,
                PROGRESS_CD AS status,
                REG_DATE AS createdAt,
                BLOCK_FLAG AS blockFlag,
                PASSWORD AS password,
                DEL_FLAG AS delFlag
            FROM
                VN_USER
        ) U
        LEFT JOIN
            VNCH V
        ON
            U.vendorCode = V.VENDOR_CD
        <where>
            U.delFlag = 'N'
            <if test="vendorName != null and vendorName != ''">
                AND V.VENDOR_NM LIKE CONCAT('%', #{vendorName}, '%')
            </if>
            <if test="userId != null and userId != ''">
                AND U.userId LIKE CONCAT('%', #{userId}, '%')
            </if>
            <if test="userName != null and userName != ''">
                AND U.userName LIKE CONCAT('%', #{userName}, '%')
            </if>
            <if test="blockFlag != null and blockFlag != ''">
                AND U.blockFlag = #{blockFlag}
            </if>
            <if test="startDate != null">
                AND U.createdAt <![CDATA[>=]]> #{startDate}
            </if>
            <if test="endDate != null">
                AND U.createdAt <![CDATA[<=]]> #{endDate}
            </if>
            <if test="phone != null and phone != ''">
                AND U.phone LIKE CONCAT('%', #{phone}, '%')
            </if>
        </where>
        ORDER BY
            U.createdAt DESC
    </select>
    <!--마스터 테이블 협력사 유저 정보 저장-->
    <insert id="insertUserVN_USER" parameterType="com.company.erp.master.vendoruser.dto.VendorUserRegisterDto">
        INSERT INTO
        VN_USER(
            VENDOR_CD,
            USER_ID,
            USER_NM,
            USER_NM_ENG,
            REG_DATE,
            REG_USER_ID,
            MOD_DATE,
            MOD_USER_ID,
            DEL_FLAG,
            BLOCK_FLAG,
            BLOCK_RMK,
            BLOCK_DATE,
            PASSWORD,
            PW_WRONG_CNT,
            EMAIL,
            TEL_NUM,
            FAX_NUM,
            ROLE,
            SIGN_DATE,
            PROGRESS_CD,
            COM_TYPE
        )
        VALUES(
            #{vendorCode},
            #{userId},
            #{userName},
            #{userNameEng},
            #{createdAt},
            #{createdBy},
            #{modifiedAt},
            #{modifiedBy},
            'N',
            'N',
            NULL,
            NULL,
            #{password},
            0,
            #{email},
            #{phone},
            #{fax},
            NULL,
            #{signDate},
            'A',
            'V'
        )
    </insert>

    <!--대기 테이블 협력사 유저 정보 저장-->
    <insert id="insertUserVNCH_US" parameterType="com.company.erp.master.vendoruser.dto.VendorUserRegisterDto">
        INSERT INTO
        VNCH_US(
            ASK_USER_NUM,
            VENDOR_CD,
            REG_DATE,
            REG_USER_ID,
            MOD_DATE,
            MOD_USER_ID,
            DEL_FLAG,
            USER_ID,
            USER_NM,
            PROGRESS_CD,
            REQ_TYPE,
            TEL_NO,
            FAX_NO,
            EMAIL,
            PASSWORD,
            COM_TYPE
        )
        VALUES(
            #{askUserNum},
            #{vendorCode},
            #{createdAt},
            #{createdBy},
            #{modifiedAt},
            #{modifiedBy},
            'N',
            #{userId},
            #{userName},
            #{status},
            'I',
            #{phone},
            #{fax},
            #{email},
            #{password},
            'V'
        )
    </insert>

    <!--대기 테이블 협력사 유저 정보 업데이트-->
    <update id="updateVNCH_USByAskUserNum" parameterType="com.company.erp.master.vendoruser.dto.VendorUserUpdateDto">
        UPDATE
            VNCH_US
        <set>
            MOD_DATE = #{modifiedAt},
            MOD_USER_ID = #{modifiedBy},
            <if test="delFlag != null and delFlag != ''">
                DEL_FLAG = #{delFlag},
            </if>
            <if test="status != null and status != ''">
                PROGRESS_CD = #{status},
            </if>
            <if test="rejectRemark != null and rejectRemark != ''">
                REJECT_RMK = #{rejectRemark},
            </if>
        </set>
        WHERE
            ASK_USER_NUM = #{askUserNum}
        AND
            PROGRESS_CD IN ('C', 'N')
    </update>

    <!--아이디 중복 체크-->
    <select id="existsUserId" parameterType="String" resultType="boolean">
        SELECT
            COUNT(*)
        FROM
            VN_USER
        WHERE
            USER_ID=#{userId}
    </select>

    <!--협력사 유저 단일 조회-->
    <select id="selectVendorUserByAskUserNum" parameterType="String" resultType="com.company.erp.master.vendoruser.dto.VendorUserRegisterDto">
        SELECT
        ASK_USER_NUM AS askUserNum,
        VENDOR_CD AS vendorCode,
        REG_DATE AS createdAt,
        REG_USER_ID AS createdBy,
        MOD_DATE AS modifiedAt,
        MOD_USER_ID AS modifiedBy,
        USER_NM AS userName,
        TEL_NO AS phone,
        FAX_NO AS fax,
        EMAIL AS email,
        PROGRESS_CD AS status
        FROM
            VNCH_US
        WHERE
            ASK_USER_NUM = #{askUserNum}
        AND
            PROGRESS_CD IN ('N', 'C')
        AND
            DEL_FLAG = 'N'
    </select>

</mapper>