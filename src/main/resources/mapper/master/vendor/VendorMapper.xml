<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.company.erp.master.vendor.mapper.VendorMapper">
    <!--협력사 조회-->
<!--    <select id="selectVendorList" parameterType="com.company.erp.master.vendor.dto.VendorSearchDto" resultType="com.company.erp.master.vendor.dto.VendorListDto"> &lt;!&ndash;자동으로 list 반환&ndash;&gt;-->
<!--        SELECT-->
<!--            &lt;!&ndash;위 테이블 우선 조회&ndash;&gt;-->
<!--            NULL AS askNum,-->
<!--            VENDOR_CD AS vendorCode,-->
<!--            VENDOR_NM AS vendorName,-->
<!--            VENDOR_ENG_NM AS vendorNameEng,-->
<!--            REG_TYPE AS businessType,-->
<!--            CEO_USER_NM AS ceoName,-->
<!--            ADDR AS address,-->
<!--            INDUSTRY_TYPE AS industry,-->
<!--            USE_FLAG AS useYn,-->
<!--            PROGRESS_CD AS status,-->
<!--            REG_DATE AS createdAt,-->
<!--            IRS_NO AS businessNo,-->
<!--            TEL_NO AS tel,-->
<!--            FAX_NO AS fax,-->
<!--            ZIP_CD AS zipCode,-->
<!--            ADDR_DT AS addressDetail,-->
<!--            FOUNDATION_DATE AS foundationDate,-->
<!--            RMK AS remark-->
<!--        FROM-->
<!--            VNGL-->
<!--        <where>-->
<!--            DEL_FLAG = 'N'-->
<!--            <if test="vendorCode != null and vendorCode != ''">-->
<!--                AND VENDOR_CD LIKE CONCAT('%', #{vendorCode}, '%')-->
<!--            </if>-->
<!--            <if test="vendorName != null and vendorName != ''">-->
<!--                AND VENDOR_NM LIKE CONCAT('%', #{vendorName}, '%')-->
<!--            </if>-->
<!--            <if test="businessType != null and businessType != ''">-->
<!--                AND REG_TYPE = #{businessType}-->
<!--            </if>-->
<!--            <if test="useYn != null and useYn != ''">-->
<!--                AND USE_FLAG = #{useYn}-->
<!--            </if>-->
<!--            <if test="industry != null and industry != ''">-->
<!--                AND INDUSTRY_TYPE LIKE CONCAT('%', #{industry}, '%')-->
<!--            </if>-->

<!--            AND-->
<!--                PROGRESS_CD IN ('A')-->
<!--            AND-->
<!--                VENDOR_CD NOT IN (-->
<!--                    SELECT VENDOR_CD FROM VNCH-->
<!--                    WHERE PROGRESS_CD IN ('N', 'C', 'R')-->
<!--                    AND DEL_FLAG = 'N'-->
<!--                )-->
<!--        </where>-->

<!--        UNION ALL-->

<!--        SELECT-->
<!--            ASK_NUM AS askNum,-->
<!--            VENDOR_CD AS vendorCode,-->
<!--            VENDOR_NM AS vendorName,-->
<!--            VENDOR_ENG_NM AS vendorNameEng,-->
<!--            REG_TYPE AS businessType,-->
<!--            CEO_USER_NM AS ceoName,-->
<!--            ADDR AS address,-->
<!--            INDUSTRY_TYPE AS industry,-->
<!--            NULL AS useYn,-->
<!--            PROGRESS_CD AS status,-->
<!--            REG_DATE AS createdAt,-->
<!--            IRS_NO AS businessNo,-->
<!--            TEL_NO AS tel,-->
<!--            FAX_NO AS fax,-->
<!--            ZIP_CD AS zipCode,-->
<!--            ADDR_DT AS addressDetail,-->
<!--            FOUNDATION_DATE AS foundationDate,-->
<!--            RMK AS remark-->
<!--        FROM-->
<!--            VNCH-->
<!--        <where>-->
<!--            DEL_FLAG = 'N'-->
<!--            <if test="vendorCode != null and vendorCode != ''">-->
<!--                AND VENDOR_CD LIKE CONCAT('%', #{vendorCode}, '%')-->
<!--            </if>-->
<!--            <if test="vendorName != null and vendorName != ''">-->
<!--                AND VENDOR_NM LIKE CONCAT('%', #{vendorName}, '%')-->
<!--            </if>-->
<!--            <if test="businessType != null and businessType != ''">-->
<!--                AND REG_TYPE = #{businessType}-->
<!--            </if>-->
<!--            <if test="industry != null and industry != ''">-->
<!--                AND INDUSTRY_TYPE LIKE CONCAT('%', #{industry}, '%')-->
<!--            </if>-->
<!--            AND PROGRESS_CD IN ('C', 'N', 'R')-->
<!--            AND ASK_NUM IN (-->
<!--                    SELECT MAX(ASK_NUM)-->
<!--                    FROM VNCH-->
<!--                    WHERE DEL_FLAG = 'N'-->
<!--                    GROUP BY VENDOR_CD-->
<!--                )-->
<!--        </where>-->

<!--        ORDER BY-->
<!--            createdAt DESC-->
<!--    </select>-->
    <select id="selectVendorList" parameterType="com.company.erp.master.vendor.dto.VendorSearchDto" resultType="com.company.erp.master.vendor.dto.VendorListDto">
        SELECT * FROM (
            SELECT
                ASK_NUM AS askNum,
                VENDOR_CD AS vendorCode,
                VENDOR_NM AS vendorName,
                VENDOR_ENG_NM AS vendorNameEng,
                REG_TYPE AS businessType,
                CEO_USER_NM AS ceoName,
                ADDR AS address,
                INDUSTRY_TYPE AS industry,
                PROGRESS_CD AS status,
                REG_DATE AS createdAt,
                IRS_NO AS businessNo,
                TEL_NO AS tel,
                FAX_NO AS fax,
                ZIP_CD AS zipCode,
                ADDR_DT AS addressDetail,
                FOUNDATION_DATE AS foundationDate,
                RMK AS remark,
                <!--1. 업체코드별로 묶어서 등록일과 요청 번호를 최신순(DESC)으로 번호를 매김-->
                ROW_NUMBER() OVER(PARTITION BY VENDOR_CD ORDER BY REG_DATE DESC, ASK_NUM DESC) as rn
            FROM
                VNCH
            <where>
                DEL_FLAG = 'N'
                <if test="vendorCode != null and vendorCode != ''">
                    AND VENDOR_CD LIKE CONCAT('%', #{vendorCode}, '%')
                </if>
                <if test="vendorName != null and vendorName != ''">
                    AND VENDOR_NM LIKE CONCAT('%', #{vendorName}, '%')
                </if>
                <if test="businessType != null and businessType != ''">
                    AND REG_TYPE = #{businessType}
                </if>
                <if test="industry != null and industry != ''">
                    AND INDUSTRY_TYPE LIKE CONCAT('%', #{industry}, '%')
                </if>
            </where>
            ) T
        <!--2. 번호 매긴 것 중 무조건 가장 최신 데이터만 가져옴-->
        WHERE
            T.rn = 1
        ORDER BY
            T.createdAt DESC
    </select>

    <!--대기 테이블 협력사 단일 조회-->
    <select id="selectVendorByAskNum" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        SELECT
            ASK_NUM AS askNum,
            VENDOR_CD AS vendorCode,
            REG_DATE AS createdAt,
            REG_USER_ID AS createdBy,
            MOD_DATE AS modifiedAt,
            MOD_USER_ID AS modifiedBy,
            DEL_FLAG AS delFlag,
            VENDOR_NM AS vendorName,
            VENDOR_ENG_NM AS vendorNameEng,
            REG_TYPE AS businessType,
            IRS_NO AS businessNo,
            CEO_USER_NM AS ceoName,
            ZIP_CD AS zipCode,
            ADDR AS address,
            ADDR_DT AS addressDetail,
            TEL_NO AS tel,
            FAX_NO AS fax,
            EMAIL AS email,
            FOUNDATION_DATE AS foundationDate,
            INDUSTRY_TYPE AS industry,
            RMK AS remark,
            PROGRESS_CD AS status,
            SIGN_DATE AS signDate
        FROM
            VNCH
        WHERE
            ASK_NUM = #{askNum}
        AND
            PROGRESS_CD IN ('N', 'C')
        AND
            DEL_FLAG = 'N'
    </select>

    <!--협력사 마스터 테이블 저장-->
    <insert id="insertVendorVNGL" parameterType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        INSERT INTO
        VNGL(
            VENDOR_CD,
            REG_DATE,
            REG_USER_ID,
            MOD_DATE,
            MOD_USER_ID,
            DEL_FLAG,
            USE_FLAG,
            VENDOR_NM,
            VENDOR_ENG_NM,
            REG_TYPE,
            IRS_NO,
            CEO_USER_NM,
            ZIP_CD,
            ADDR,
            ADDR_DT,
            TEL_NO,
            FAX_NO,
            EMAIL,
            FOUNDATION_DATE,
            INDUSTRY_TYPE,
            ATT_FILE_NUM,
            RMK,
            PROGRESS_CD,
            SIGN_DATE
        )
        VALUES(
            #{vendorCode},
            #{createdAt},
            #{createdBy},
            #{modifiedAt},
            #{modifiedBy},
            'N',
            'Y',
            #{vendorName},
            #{vendorNameEng},
            #{businessType},
            #{businessNo},
            #{ceoName},
            #{zipCode},
            #{address},
            #{addressDetail},
            #{tel},
            #{fax},
            #{email},
            #{foundationDate},
            #{industry},
            #{attFileNum},
            #{remark},
            "A",
            #{signDate}
        )
    </insert>
    <!--협력사 대기 테이블 저장-->
    <insert id="insertVendorVNCH" parameterType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        INSERT INTO
        VNCH(
            ASK_NUM,
            VENDOR_CD,
            REG_DATE,
            REG_USER_ID,
            MOD_DATE,
            MOD_USER_ID,
            DEL_FLAG,
            VENDOR_NM,
            VENDOR_ENG_NM,
            REG_TYPE,
            IRS_NO,
            CEO_USER_NM,
            ZIP_CD,
            ADDR,
            ADDR_DT,
            TEL_NO,
            FAX_NO,
            EMAIL,
            FOUNDATION_DATE,
            INDUSTRY_TYPE,
            RMK,
            PROGRESS_CD,
            REJECT_RMK,
            SIGN_USER_ID,
            COM_TYPE
        )
        VALUES(
            #{askNum},
            #{vendorCode},
            #{createdAt},
            #{createdBy},
            NULL,
            NULL,
            'N',
            #{vendorName},
            #{vendorNameEng},
            #{businessType},
            #{businessNo},
            #{ceoName},
            #{zipCode},
            #{address},
            #{addressDetail},
            #{tel},
            #{fax},
            #{email},
            #{foundationDate},
            #{industry},
            #{remark},
            #{status},
            NULL,
            NULL,
            'V'
        )
    </insert>

    <!--마스터 테이블 상태 업데이트-->
    <update id="updateVNGLByVendorCode" parameterType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        UPDATE
            VNGL
        <set>
            MOD_DATE = #{modifiedAt},
            MOD_USER_ID = #{modifiedBy},
            PROGRESS_CD = 'A',
            SIGN_DATE = NOW(),
            <if test="vendorName != null and vendorName != ''">
                VENDOR_NM = #{vendorName},
            </if>
            <if test="vendorNameEng != null and vendorNameEng != ''">
                VENDOR_ENG_NM = #{vendorNameEng},
            </if>
            <if test="businessType != null and businessType != ''">
                REG_TYPE = #{businessType},
            </if>
            <if test="ceoName != null and ceoName != ''">
                CEO_USER_NM = #{ceoName},
            </if>
            <if test="zipCode != null and zipCode != ''">
                ZIP_CD = #{zipCode},
            </if>
            <if test="address != null and address != ''">
                ADDR = #{address},
            </if>
            <if test="addressDetail != null and addressDetail != ''">
                ADDR_DT = #{addressDetail},
            </if>
            <if test="tel != null and tel != ''">
                TEL_NO = #{tel},
            </if>
            <if test="industry != null and industry != ''">
                INDUSTRY_TYPE = #{industry},
            </if>
            <if test="remark != null and remark != ''">
                RMK = #{remark},
            </if>
        </set>
        WHERE
            VENDOR_CD = #{vendorCode}
        AND
            DEL_FLAG = 'N'
    </update>

    <!--대기 테이블 상태 업데이트-->
    <update id="updateVNCHByAskNum" parameterType="com.company.erp.master.vendor.dto.VendorUpdateDto">
        UPDATE
            VNCH
        <set>
            MOD_DATE = #{modifiedAt},
            MOD_USER_ID = #{modifiedBy},
            <if test="signUserId != null and signUserId != ''">
                SIGN_USER_ID = #{signUserId},
            </if>
            <if test="delFlag != null and delFlag != ''">
                DEL_FLAG = #{delFlag},
            </if>
            <if test="status != null and status != ''">
                PROGRESS_CD = #{status},
            </if>
            <if test="rejectRemark != null and rejectRemark != ''">
                REJECT_RMK = #{rejectRemark},
            </if>
        </set>
        WHERE
            ASK_NUM=#{askNum}
    </update>

    <!--로그인한 id로 대기 테이블 조회-->
    <select id="selectVendorVNCHByLoginId" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorListDto">

        SELECT
            V.VENDOR_CD AS vendorCode,
            VENDOR_NM AS vendorName,
            VENDOR_ENG_NM AS vendorNameEng,
            REG_TYPE AS businessType,
            IRS_NO AS businessNo,
            CEO_USER_NM AS ceoName,
            INDUSTRY_TYPE AS industry,
            ZIP_CD AS zipCode,
            ADDR AS address,
            ADDR_DT AS addressDetail,
            TEL_NO AS tel,
            V.PROGRESS_CD AS status,
            RMK AS remark
            FROM
            VNCH V
        INNER JOIN
            VN_USER U <!--이미 로그인 했다는건 승인 상태라는 의미-->
        ON
            V.VENDOR_CD = U.VENDOR_CD
        WHERE
            U.USER_ID = #{loginId}
        AND
            V.PROGRESS_CD IN ('C', 'N')

    </select>

    <!--로그인한 id로 마스터 테이블 조회-->
    <select id="selectVendorVNGLByLoginId" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorListDto">

        SELECT
            V.VENDOR_CD AS vendorCode,
            VENDOR_NM AS vendorName,
            VENDOR_ENG_NM AS vendorNameEng,
            REG_TYPE AS businessType,
            IRS_NO AS businessNo,
            CEO_USER_NM AS ceoName,
            INDUSTRY_TYPE AS industry,
            ZIP_CD AS zipCode,
            ADDR AS address,
            ADDR_DT AS addressDetail,
            TEL_NO AS tel,
            V.PROGRESS_CD AS status,
            RMK AS remark
        FROM
            VNGL V
        INNER JOIN
            VN_USER U
        ON
            V.VENDOR_CD = U.VENDOR_CD
        WHERE
            U.USER_ID = #{loginId}
        AND
            V.PROGRESS_CD = 'A'

    </select>
    
    <!--사업자 번호 중복 체크-->
    <select id="existsByBusinessNo" parameterType="String" resultType="boolean">
        <!--둘 중 하나라도 0보다 크면 TRUE 반환-->
        SELECT(
            SELECT COUNT(*) FROM VNGL WHERE IRS_NO = #{businessNo} AND DEL_FLAG = 'N'
        <!--마스터 테이블 존재 여부 확인-->
        ) + (
            SELECT COUNT(*) FROM VNCH WHERE IRS_NO = #{businessNo} AND PROGRESS_CD != 'R'
        <!--대기 테이블 존재 여부 확인 (반려 제외) -->
        ) > 0
    </select>

    <!--회사 코드로 파일 조회-->
    <select id="selectFileNumByVendorCode" parameterType="String" resultType="String">
        SELECT
            FILE_NUM
        FROM
            ATT_FILE
        WHERE
            VENDOR_CD = #{vendorCode}
        AND
            DEL_FLAG = 'N'
        ORDER BY
            REG_DATE DESC
    </select>

</mapper>