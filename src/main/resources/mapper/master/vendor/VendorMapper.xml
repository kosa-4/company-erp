<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.company.erp.master.vendor.mapper.VendorMapper">
    <!--협력사 조회-->
    <select id="selectVendorList" parameterType="com.company.erp.master.vendor.dto.VendorSearchDto" resultType="com.company.erp.master.vendor.dto.VendorListDto">
        SELECT
            CH.ASK_NUM AS askNum,
            COALESCE(CH.PROGRESS_CD, 'A') AS status,
            CH.REG_DATE AS createdAt,
            CH.REJECT_RMK AS rejectReason,
            GL.VENDOR_CD AS vendorCode,
            GL.VENDOR_NM AS vendorName,
            GL.VENDOR_ENG_NM AS vendorNameEng,
            GL.REG_TYPE AS businessType,
            GL.CEO_USER_NM AS ceoName,
            GL.ADDR AS address,
            GL.INDUSTRY_TYPE AS industry,
            GL.IRS_NO AS businessNo,
            GL.TEL_NO AS tel,
            GL.FAX_NO AS fax,
            GL.EMAIL AS email,
            GL.ZIP_CD AS zipCode,
            GL.ADDR_DT AS addressDetail,
            GL.FOUNDATION_DATE AS foundationDate,
            GL.RMK AS remark
        FROM
            VNGL GL
        LEFT JOIN(
            SELECT
                ASK_NUM,
                PROGRESS_CD,
                REG_DATE,
                VENDOR_CD,
                REJECT_RMK,
                ROW_NUMBER() OVER (
                    PARTITION BY VENDOR_CD
                    ORDER BY REG_DATE DESC, ASK_NUM DESC
                ) rn
            FROM
                VNCH
            WHERE
                DEL_FLAG = 'N'

        ) CH
        ON
            GL.VENDOR_CD = CH.VENDOR_CD
        AND
            CH.rn = 1
        <where>
            DEL_FLAG = 'N'
            <if test="vendorCode != null and vendorCode != ''">
                AND GL.VENDOR_CD LIKE CONCAT('%', #{vendorCode}, '%')
            </if>
            <if test="vendorName != null and vendorName != ''">
                AND GL.VENDOR_NM LIKE CONCAT('%', #{vendorName}, '%')
            </if>
            <if test="businessType != null and businessType != ''">
                AND GL.REG_TYPE = #{businessType}
            </if>
            <if test="industry != null and industry != ''">
                AND GL.INDUSTRY_TYPE LIKE CONCAT('%', #{industry}, '%')
            </if>
        </where>
        ORDER BY
            CH.REG_DATE DESC
    </select>

    <!--대기 테이블 협력사 단일 조회-->
    <select id="selectVendorByAskNum" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        SELECT
            ASK_NUM AS askNum,
            VENDOR_CD AS vendorCode,
            REG_DATE AS createdAt,
            REG_USER_ID AS createdBy,
            MOD_DATE AS modifiedAt,
            MOD_USER_ID AS modifiedBy,
            DEL_FLAG AS delFlag,
            VENDOR_NM AS vendorName,
            VENDOR_ENG_NM AS vendorNameEng,
            REG_TYPE AS businessType,
            IRS_NO AS businessNo,
            CEO_USER_NM AS ceoName,
            ZIP_CD AS zipCode,
            ADDR AS address,
            ADDR_DT AS addressDetail,
            TEL_NO AS tel,
            FAX_NO AS fax,
            EMAIL AS email,
            FOUNDATION_DATE AS foundationDate,
            INDUSTRY_TYPE AS industry,
            RMK AS remark,
            PROGRESS_CD AS status,
            SIGN_DATE AS signDate
        FROM
            VNCH
        WHERE
            ASK_NUM = #{askNum}
        AND
            PROGRESS_CD IN ('N', 'C')
        AND
            DEL_FLAG = 'N'
    </select>

    <!--마스터 테이블 단일 조회-->
    <select id="selectVendorVNGLByVendorCode" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        SELECT
            VENDOR_CD AS vendorCode,
            VENDOR_NM AS vendorName,
            VENDOR_ENG_NM AS vendorNameEng,
            REG_TYPE AS businessType,
            IRS_NO AS businessNo,
            CEO_USER_NM AS ceoName,
            ZIP_CD AS zipCode,
            ADDR AS address,
            ADDR_DT AS addressDetail,
            TEL_NO AS tel,
            FAX_NO AS fax,
            EMAIL AS email,
            FOUNDATION_DATE AS foundationDate,
            INDUSTRY_TYPE AS industry,
            RMK AS remark
        FROM
            VNGL
        WHERE
            VENDOR_CD = #{vendorCode}
        AND
            DEL_FLAG = 'N'
    </select>

    <!--협력사 마스터 테이블 저장-->
    <insert id="insertVendorVNGL" parameterType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        INSERT INTO
        VNGL(
            VENDOR_CD,
            REG_DATE,
            REG_USER_ID,
            MOD_DATE,
            MOD_USER_ID,
            DEL_FLAG,
            USE_FLAG,
            VENDOR_NM,
            VENDOR_ENG_NM,
            REG_TYPE,
            IRS_NO,
            CEO_USER_NM,
            ZIP_CD,
            ADDR,
            ADDR_DT,
            TEL_NO,
            FAX_NO,
            EMAIL,
            FOUNDATION_DATE,
            INDUSTRY_TYPE,
            ATT_FILE_NUM,
            RMK,
            PROGRESS_CD,
            SIGN_DATE
        )
        VALUES(
            #{vendorCode},
            #{createdAt},
            #{createdBy},
            #{modifiedAt},
            #{modifiedBy},
            'N',
            'Y',
            #{vendorName},
            #{vendorNameEng},
            #{businessType},
            #{businessNo},
            #{ceoName},
            #{zipCode},
            #{address},
            #{addressDetail},
            #{tel},
            #{fax},
            #{email},
            #{foundationDate},
            #{industry},
            #{attFileNum},
            #{remark},
            "A",
            #{signDate}
        )
    </insert>
    <!--협력사 대기 테이블 저장-->
    <insert id="insertVendorVNCH" parameterType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        INSERT INTO
        VNCH(
            ASK_NUM,
            VENDOR_CD,
            REG_DATE,
            REG_USER_ID,
            MOD_DATE,
            MOD_USER_ID,
            DEL_FLAG,
            VENDOR_NM,
            VENDOR_ENG_NM,
            REG_TYPE,
            IRS_NO,
            CEO_USER_NM,
            ZIP_CD,
            ADDR,
            ADDR_DT,
            TEL_NO,
            FAX_NO,
            EMAIL,
            FOUNDATION_DATE,
            INDUSTRY_TYPE,
            RMK,
            PROGRESS_CD,
            REJECT_RMK,
            SIGN_USER_ID,
            COM_TYPE
        )
        SELECT
            #{askNum},
            #{vendorCode},
            #{createdAt},
            #{createdBy},
            NULL,
            NULL,
            'N',
            #{vendorName},
            #{vendorNameEng},
            #{businessType},
            #{businessNo},
            #{ceoName},
            #{zipCode},
            #{address},
            #{addressDetail},
            #{tel},
            #{fax},
            #{email},
            #{foundationDate},
            #{industry},
            #{remark},
            #{status},
            NULL,
            NULL,
            'V'
        FROM
            DUAL
        WHERE NOT EXISTS
            (SELECT 1 FROM VNCH WHERE VENDOR_CD = #{vendorCode} AND PROGRESS_CD = 'C')
    </insert>

    <!--마스터 테이블 상태 업데이트-->
    <update id="updateVNGLByVendorCode" parameterType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        UPDATE
            VNGL
        <set>
            MOD_DATE = #{modifiedAt},
            MOD_USER_ID = #{modifiedBy},
            PROGRESS_CD = 'A',
            SIGN_DATE = NOW(),
            <if test="vendorName != null and vendorName != ''">
                VENDOR_NM = #{vendorName},
            </if>
            <if test="vendorNameEng != null and vendorNameEng != ''">
                VENDOR_ENG_NM = #{vendorNameEng},
            </if>
            <if test="businessType != null and businessType != ''">
                REG_TYPE = #{businessType},
            </if>
            <if test="ceoName != null and ceoName != ''">
                CEO_USER_NM = #{ceoName},
            </if>
            <if test="zipCode != null and zipCode != ''">
                ZIP_CD = #{zipCode},
            </if>
            <if test="address != null and address != ''">
                ADDR = #{address},
            </if>
            <if test="addressDetail != null and addressDetail != ''">
                ADDR_DT = #{addressDetail},
            </if>
            <if test="tel != null and tel != ''">
                TEL_NO = #{tel},
            </if>
            <if test="industry != null and industry != ''">
                INDUSTRY_TYPE = #{industry},
            </if>
            <if test="remark != null and remark != ''">
                RMK = #{remark},
            </if>
        </set>
        WHERE
            VENDOR_CD = #{vendorCode}
        AND
            DEL_FLAG = 'N'
    </update>

    <!--대기 테이블 상태 업데이트-->
    <update id="updateVNCHByAskNum" parameterType="com.company.erp.master.vendor.dto.VendorUpdateDto">
        UPDATE
            VNCH
        <set>
            MOD_DATE = #{modifiedAt},
            MOD_USER_ID = #{modifiedBy},
            <if test="signUserId != null and signUserId != ''">
                SIGN_USER_ID = #{signUserId},
            </if>
            <if test="delFlag != null and delFlag != ''">
                DEL_FLAG = #{delFlag},
            </if>
            <if test="status != null and status != ''">
                PROGRESS_CD = #{status},
            </if>
            <if test="rejectRemark != null and rejectRemark != ''">
                REJECT_RMK = #{rejectRemark},
            </if>
        </set>
        WHERE
            ASK_NUM=#{askNum}
    </update>

    <!--대기 상태 여부 확인-->
    <select id="countPending" parameterType="String" resultType="int">
        <!--해당 사용자(VENDOR)의 VNCH 이력 중 최신 1건이 상태('C','N')인 경우 1 반환 아니면 0-->
        SELECT COUNT(*) FROM (
            SELECT
                V.PROGRESS_CD AS status,
                ROW_NUMBER() OVER (
                PARTITION BY V.VENDOR_CD
                ORDER BY V.REG_DATE DESC, V.ASK_NUM DESC
                ) AS rn
            FROM
                VNCH V
            INNER JOIN
                VN_USER U
            ON
                V.VENDOR_CD = U.VENDOR_CD
            WHERE
                U.USER_ID = #{loginId}
            AND
                V.DEL_FLAG = 'N'
            ) T
        WHERE T.rn =  1
        AND T.status IN ('C', 'N')
    </select>

    <!--로그인한 id로 대기 테이블 조회-->
    <select id="selectVendorVNCHByLoginId" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorListDto">
        SELECT * FROM (
            SELECT
                V.VENDOR_CD AS vendorCode,
                V.VENDOR_NM AS vendorName,
                V.VENDOR_ENG_NM AS vendorNameEng,
                V.REG_TYPE AS businessType,
                V.IRS_NO AS businessNo,
                V.CEO_USER_NM AS ceoName,
                V.INDUSTRY_TYPE AS industry,
                V.ZIP_CD AS zipCode,
                V.ADDR AS address,
                V.ADDR_DT AS addressDetail,
                V.TEL_NO AS tel,
                V.PROGRESS_CD AS status,
                V.RMK AS remark,
                ROW_NUMBER() OVER (
                    PARTITION BY V.VENDOR_CD
                    ORDER BY V.REG_DATE DESC, V.ASK_NUM DESC
                ) AS rn
            FROM
                VNCH V
            INNER JOIN
                VN_USER U
            ON
                V.VENDOR_CD = U.VENDOR_CD
            WHERE
                U.USER_ID = #{loginId}
            AND
                V.DEL_FLAG = 'N'
            ) T
        WHERE T.rn = 1
        AND T.status IN ('C', 'N')
    </select>

    <!--로그인한 id로 마스터 테이블 조회-->
    <select id="selectVendorVNGLByLoginId" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorListDto">

        SELECT
            V.VENDOR_CD AS vendorCode,
            VENDOR_NM AS vendorName,
            VENDOR_ENG_NM AS vendorNameEng,
            REG_TYPE AS businessType,
            IRS_NO AS businessNo,
            CEO_USER_NM AS ceoName,
            INDUSTRY_TYPE AS industry,
            ZIP_CD AS zipCode,
            ADDR AS address,
            ADDR_DT AS addressDetail,
            TEL_NO AS tel,
            V.PROGRESS_CD AS status,
            RMK AS remark
        FROM
            VNGL V
        INNER JOIN
            VN_USER U
        ON
            V.VENDOR_CD = U.VENDOR_CD
        WHERE
            U.USER_ID = #{loginId}
        AND
            V.PROGRESS_CD = 'A'
        AND
            V.DEL_FLAG = 'N'

    </select>
    <!--사업자 번호 중복 체크-->
    <select id="existsByBusinessNo" parameterType="String" resultType="boolean">
        <!--둘 중 하나라도 0보다 크면 TRUE 반환-->
        SELECT(
            SELECT COUNT(*) FROM VNGL WHERE IRS_NO = #{businessNo} AND DEL_FLAG = 'N'
        <!--마스터 테이블 존재 여부 확인-->
        ) + (
            SELECT COUNT(*) FROM VNCH WHERE IRS_NO = #{businessNo} AND PROGRESS_CD != 'R'
        <!--대기 테이블 존재 여부 확인 (반려 제외) -->
        ) > 0
    </select>

    <!--회사 코드로 최신 요청 데이터 조회-->
    <select id="selectVendorVNCHByVendorCode" parameterType="String" resultType="com.company.erp.master.vendor.dto.VendorRegisterDto">
        SELECT
            VENDOR_CD AS vendorCode,
            VENDOR_NM AS vendorName,
            VENDOR_ENG_NM AS vendorNameEng,
            REG_TYPE AS businessType,
            IRS_NO AS businessNo,
            CEO_USER_NM AS ceoName,
            INDUSTRY_TYPE AS industry,
            ZIP_CD AS zipCode,
            ADDR AS address,
            ADDR_DT AS addressDetail,
            TEL_NO AS tel,
            PROGRESS_CD AS status,
            RMK AS remark
        FROM
            VNCH
        WHERE
            VENDOR_CD = #{vendorCode}
        AND
            DEL_FLAG = 'N'
        ORDER BY
            REG_DATE DESC, ASK_NUM DESC
        LIMIT 1
    </select>

    <!--회사 코드로 파일 조회-->
    <select id="selectFileNumByVendorCode" parameterType="String" resultType="String">
        SELECT
            FILE_NUM
        FROM
            ATT_FILE
        WHERE
            VENDOR_CD = #{vendorCode}
        AND
            DEL_FLAG = 'N'
        ORDER BY
            REG_DATE DESC
    </select>

    <!--협력사 정보 업데이트-->
    <update id="updateVendorVNGL" parameterType="com.company.erp.master.vendor.dto.VendorUpdateDto">
        UPDATE
            VNGL
        <set>
            <if test="vendorName != null and vendorName != ''">
                VENDOR_NM = #{vendorName},
            </if>
            <if test="vendorNameEng != null and vendorNameEng != ''">
                VENDOR_ENG_NM = #{vendorNameEng},
            </if>
            <if test="ceoName != null and ceoName != ''">
                CEO_USER_NM = #{ceoName},
            </if>
            <if test="tel != null and tel != ''">
                TEL_NO = #{tel},
            </if>
            <if test="email != null and email != ''">
                EMAIL = #{email},
            </if>
            <if test="zipCode != null and zipCode != ''">
                ZIP_CD = #{zipCode},
            </if>
            <if test="address != null and address != ''">
                ADDR = #{address},
            </if>
            <if test="remark != null and remark != ''">
                RMK = #{remark},
            </if>
            MOD_DATE = #{modifiedAt},
            MOD_USER_ID = #{modifiedBy},
            PROGRESS_CD = 'A'
        </set>
        WHERE
            VENDOR_CD = #{vendorCode}
        AND
            DEL_FLAG = 'N'
    </update>

</mapper>