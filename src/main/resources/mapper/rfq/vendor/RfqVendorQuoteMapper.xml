<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.company.erp.rfq.vendor.quote.mapper.RfqVendorQuoteMapper">

    <!-- 견적 헤더 정보 조회 -->
    <select id="selectQuoteHeader"
        resultType="com.company.erp.rfq.vendor.quote.dto.response.VendorQuoteResponse"> SELECT
        h.RFQ_NUM as rfqNum, h.RFQ_SUBJECT as rfqSubject, h.RFQ_DATE as rfqDate, h.REQ_CLOSE_DATE as
        reqCloseDate, h.PROGRESS_CD as progressCd, v.PROGRESS_CD as vendorProgressCd FROM rfqhd h
        INNER JOIN rfqvn v ON h.RFQ_NUM = v.RFQ_NUM WHERE h.RFQ_NUM = #{rfqNum} AND v.VENDOR_CD =
        #{vendorCd} AND h.DEL_FLAG = 'N' AND v.DEL_FLAG = 'N' </select>

    <!-- 견적 품목 목록 조회 (RFQDT + RFQVNDT 조인) -->
    <select id="selectQuoteItems"
        resultType="com.company.erp.rfq.vendor.quote.dto.response.VendorQuoteResponse$QuoteItemInfo">
        SELECT d.LINE_NO as lineNo, d.ITEM_CD as itemCd, d.ITEM_DESC as itemDesc, d.ITEM_SPEC as
        itemSpec, d.UNIT_CD as unitCd, d.RFQ_QT as rfqQt, COALESCE(vd.QUOTE_UNIT_PRC, 0) as
        quoteUnitPrc, COALESCE(vd.QUOTE_QT, d.RFQ_QT) as quoteQt, COALESCE(vd.QUOTE_AMT, 0) as
        quoteAmt, vd.DELY_DATE as delyDate, vd.RMK as rmk FROM rfqdt d LEFT JOIN rfqvndt vd ON
        d.RFQ_NUM = vd.RFQ_NUM AND d.LINE_NO = vd.LINE_NO AND vd.VENDOR_CD = #{vendorCd} AND
        vd.DEL_FLAG = 'N' WHERE d.RFQ_NUM = #{rfqNum} AND d.DEL_FLAG = 'N' ORDER BY d.LINE_NO </select>

    <!-- RFQVNDT 존재 여부 확인 -->
    <select id="countRfqVndt" resultType="int"> SELECT COUNT(*) FROM rfqvndt WHERE RFQ_NUM =
        #{rfqNum} AND VENDOR_CD = #{vendorCd} AND DEL_FLAG = 'N' </select>

    <!-- RFQDT에서 RFQVNDT로 초기 복사 -->
    <insert id="insertRfqVndtFromRfqdt"> INSERT INTO rfqvndt ( RFQ_NUM, LINE_NO, VENDOR_CD,
        REG_DATE, REG_USER_ID, DEL_FLAG, QUOTE_UNIT_PRC, QUOTE_QT, QUOTE_AMT, DELY_DATE, SELECT_YN,
        RMK ) SELECT RFQ_NUM, LINE_NO, #{vendorCd}, NOW(), #{userId}, 'N', 0, RFQ_QT, 0, NULL, 'N',
        NULL FROM rfqdt WHERE RFQ_NUM = #{rfqNum} AND DEL_FLAG = 'N' </insert>

    <!-- RFQVNDT 품목 업데이트 -->
    <update id="updateRfqVndtItem"> UPDATE rfqvndt SET QUOTE_UNIT_PRC = #{item.quoteUnitPrc},
        QUOTE_QT = #{item.quoteQt}, QUOTE_AMT = #{item.quoteAmt}, DELY_DATE = #{item.delyDate}, RMK
        = #{item.rmk}, MOD_DATE = NOW(), MOD_USER_ID = #{userId} WHERE RFQ_NUM = #{rfqNum} AND
        LINE_NO = #{item.lineNo} AND VENDOR_CD = #{vendorCd} </update>

    <!-- RFQVN 상태 및 총액 업데이트 -->
    <update id="updateRfqVnStatusAndAmount"> UPDATE rfqvn SET PROGRESS_CD = #{progressCd}, TOTAL_AMT
        = #{totalAmt}, <if test="progressCd == 'RFQC'"> SUBMIT_DATE = NOW(), </if> MOD_DATE = NOW(),
        MOD_USER_ID = #{userId} WHERE RFQ_NUM = #{rfqNum} AND VENDOR_CD = #{vendorCd} </update>

    <!-- RFQVN 상태 조회 -->
    <select id="selectRfqVnStatus" resultType="map"> SELECT PROGRESS_CD as progressCd, SELECT_YN as
        selectYn FROM rfqvn WHERE RFQ_NUM = #{rfqNum} AND VENDOR_CD = #{vendorCd} AND DEL_FLAG = 'N' </select>

    <!-- RFQHD 상태 조회 -->
    <select id="selectRfqHdStatus" resultType="string"> SELECT PROGRESS_CD FROM rfqhd WHERE RFQ_NUM
        = #{rfqNum} AND DEL_FLAG = 'N' </select>

</mapper>