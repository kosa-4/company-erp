<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.company.erp.rfq.buyer.result.mapper.RfqResultMapper">

    <!-- 선정 완료된 RFQ 목록 조회 -->
    <select id="selectRfqResultList" resultType="com.company.erp.rfq.buyer.result.dto.response.RfqSelectionResultResponse">
        SELECT h.RFQ_NUM        AS rfqNum,
               h.RFQ_SUBJECT    AS rfqSubject,
               h.RFQ_TYPE       AS rfqType,
               c1.CODE_NAME     AS rfqTypeNm,
               v.VENDOR_CD      AS vendorCd,
               vn.VENDOR_NM     AS vendorNm,
               v.TOTAL_AMT      AS totalAmt,
               h.CTRL_USER_ID   AS ctrlUserId,
               u.USER_NM        AS ctrlUserNm,
               h.REG_DATE       AS regDate,
               v.MOD_DATE       AS selectDate
        FROM RFQHD h
        INNER JOIN RFQVN v ON h.RFQ_NUM = v.RFQ_NUM 
            AND v.SELECT_YN = 'Y' 
            AND v.DEL_FLAG = 'N'
        INNER JOIN VNGL vn ON v.VENDOR_CD = vn.VENDOR_CD
        LEFT JOIN CODD c1 ON c1.CODE_GROUP = 'REQ_TYPE' AND h.RFQ_TYPE = c1.CODE AND c1.USE_YN = 'Y'
        LEFT JOIN BY_USER u ON h.CTRL_USER_ID = u.USER_ID
        WHERE h.DEL_FLAG = 'N'
          AND h.PROGRESS_CD = 'J'
        <if test="rfqNum != null and rfqNum != ''">
            AND h.RFQ_NUM LIKE CONCAT('%', #{rfqNum}, '%')
        </if>
        <if test="rfqSubject != null and rfqSubject != ''">
            AND h.RFQ_SUBJECT LIKE CONCAT('%', #{rfqSubject}, '%')
        </if>
        <if test="fromDate != null and fromDate != ''">
            AND h.REG_DATE &gt;= #{fromDate}
        </if>
        <if test="toDate != null and toDate != ''">
            AND h.REG_DATE &lt;= #{toDate}
        </if>
        ORDER BY v.MOD_DATE DESC, h.RFQ_NUM DESC
    </select>

    <!-- 특정 RFQ의 선정 결과 헤더 조회 -->
    <select id="selectRfqResultHeader" resultType="com.company.erp.rfq.buyer.result.dto.response.RfqSelectionResultResponse">
        SELECT h.RFQ_NUM        AS rfqNum,
               h.RFQ_SUBJECT    AS rfqSubject,
               h.RFQ_TYPE       AS rfqType,
               c1.CODE_NAME     AS rfqTypeNm,
               v.VENDOR_CD      AS vendorCd,
               vn.VENDOR_NM     AS vendorNm,
               v.TOTAL_AMT      AS totalAmt,
               h.CTRL_USER_ID   AS ctrlUserId,
               u.USER_NM        AS ctrlUserNm,
               h.REG_DATE       AS regDate,
               v.MOD_DATE       AS selectDate
        FROM RFQHD h
        INNER JOIN RFQVN v ON h.RFQ_NUM = v.RFQ_NUM 
            AND v.SELECT_YN = 'Y' 
            AND v.DEL_FLAG = 'N'
        INNER JOIN VNGL vn ON v.VENDOR_CD = vn.VENDOR_CD
        LEFT JOIN CODD c1 ON c1.CODE_GROUP = 'REQ_TYPE' AND h.RFQ_TYPE = c1.CODE AND c1.USE_YN = 'Y'
        LEFT JOIN BY_USER u ON h.CTRL_USER_ID = u.USER_ID
        WHERE h.RFQ_NUM = #{rfqNum}
          AND h.PROGRESS_CD = 'J'
          AND h.DEL_FLAG = 'N'
    </select>

    <!-- 선정된 업체의 견적 상세 품목 조회 -->
    <select id="selectRfqResultItems" resultType="com.company.erp.rfq.buyer.result.dto.response.RfqResultItem">
        SELECT d.ITEM_CD    AS itemCd,
               d.ITEM_NM    AS itemNm,
               d.SPEC       AS spec,
               d.UNIT       AS unit,
               d.QTY        AS qty,
               d.UNIT_PRICE AS unitPrice,
               d.AMT        AS amt,
               d.DLVY_DATE  AS dlvyDate,
               d.RMK        AS rmk
        FROM RFQVNDT d
        INNER JOIN RFQVN v ON d.RFQ_NUM = v.RFQ_NUM 
            AND d.VENDOR_CD = v.VENDOR_CD
        WHERE d.RFQ_NUM = #{rfqNum}
          AND v.SELECT_YN = 'Y'
          AND d.DEL_FLAG = 'N'
        ORDER BY d.ITEM_CD ASC
    </select>

</mapper>
