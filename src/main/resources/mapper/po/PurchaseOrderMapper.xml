<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.company.erp.po.mapper.PurchaseOrderMapper">

    <!-- 목록 조회 (JOIN으로 협력사명, 담당자명 포함) -->
    <select id="selectList" parameterType="map" resultType="com.company.erp.po.dto.PurchaseOrderDTO">
        SELECT h.PO_NUM AS poNo, h.PO_SUBJECT AS poName, h.PO_DATE AS poDate, h.PO_AMT AS
        totalAmount, h.PROGRESS_CD AS status, u.USER_NM AS purchaseManager, h.VENDOR_CD AS
        vendorCode, v.VENDOR_NM AS vendorName, h.PR_NUM AS prNo, h.RFQ_NUM AS rfqNo, h.PC_TYPE AS
        purchaseType, h.CHECK_FLAG AS checkFlag, h.CHECK_DATE AS checkDate, h.RMK AS remark, (
        SELECT COALESCE(SUM(d.GR_QT), 0) FROM GRDT d JOIN GRHD g ON d.GR_NUM = g.GR_NUM WHERE
        g.PO_NUM = h.PO_NUM AND g.DEL_FLAG = 'N' AND g.PROGRESS_CD != 'GRX' AND d.DEL_FLAG = 'N' AND
        d.STATUS_CD = 'N' ) AS receivedQuantity FROM POHD h LEFT JOIN VNGL v ON h.VENDOR_CD =
        v.VENDOR_CD LEFT JOIN BY_USER u ON h.CTRL_USER_ID = u.USER_ID WHERE h.DEL_FLAG = 'N' <if
            test="poNo != null and poNo != ''"> AND h.PO_NUM LIKE CONCAT('%', #{poNo}, '%') </if>
        <if
            test="poName != null and poName != ''"> AND h.PO_SUBJECT LIKE CONCAT('%', #{poName},
        '%') </if>
        <if
            test="purchaseManager != null and purchaseManager != ''"> AND u.USER_NM LIKE CONCAT('%',
        #{purchaseManager}, '%') </if>
        <if test="vendorName != null and vendorName != ''"> AND
        v.VENDOR_NM LIKE CONCAT('%', #{vendorName}, '%') </if>
        <if
            test="startDate != null and startDate != ''"> AND h.PO_DATE &gt;= #{startDate} </if>
        <if
            test="endDate != null and endDate != ''"> AND h.PO_DATE &lt;= #{endDate} </if>
        <if
            test="status != null and status != ''"> AND h.PROGRESS_CD = #{status} </if> ORDER BY
        h.REG_DATE DESC </select>

    <!-- 협력사 전용: 본인 발주 목록 조회 -->
    <select id="selectVendorOrderList" parameterType="map"
        resultType="com.company.erp.po.dto.PurchaseOrderDTO"> SELECT h.PO_NUM AS poNo, h.PO_SUBJECT
        AS poName, h.PO_DATE AS poDate, h.PO_AMT AS totalAmount, h.PROGRESS_CD AS status, u.USER_NM
        AS purchaseManager, h.VENDOR_CD AS vendorCode, v.VENDOR_NM AS vendorName, h.PR_NUM AS prNo,
        h.RFQ_NUM AS rfqNo, h.PC_TYPE AS purchaseType, h.CHECK_FLAG AS checkFlag, h.CHECK_DATE AS
        checkDate, h.RMK AS remark FROM POHD h LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD LEFT
        JOIN BY_USER u ON h.CTRL_USER_ID = u.USER_ID WHERE h.DEL_FLAG = 'N' AND h.VENDOR_CD =
        #{vendorCd} <if
            test="poNo != null and poNo != ''"> AND h.PO_NUM LIKE CONCAT('%', #{poNo}, '%') </if>
        <if
            test="poName != null and poName != ''"> AND h.PO_SUBJECT LIKE CONCAT('%', #{poName},
        '%') </if>
        <if test="status != null and status != ''"> AND h.PROGRESS_CD = #{status} </if>
        ORDER BY h.REG_DATE DESC </select>

    <!-- 상세 조회 (헤더) -->
    <select id="selectHeader" parameterType="String"
        resultType="com.company.erp.po.dto.PurchaseOrderDTO"> SELECT h.PO_NUM AS poNo, h.PO_SUBJECT
        AS poName, h.PO_DATE AS poDate, h.PO_AMT AS totalAmount, h.PROGRESS_CD AS status, u.USER_NM
        AS purchaseManager, h.VENDOR_CD AS vendorCode, v.VENDOR_NM AS vendorName, h.PR_NUM AS prNo,
        h.RFQ_NUM AS rfqNo, h.PC_TYPE AS purchaseType, h.CHECK_FLAG AS checkFlag, h.CHECK_DATE AS
        checkDate, h.RMK AS remark FROM POHD h LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD LEFT
        JOIN BY_USER u ON h.CTRL_USER_ID = u.USER_ID WHERE h.PO_NUM = #{poNo} AND h.DEL_FLAG = 'N' </select>

    <!-- 상세 조회 (품목) -->
    <select id="selectItems" parameterType="String"
        resultType="com.company.erp.po.dto.PurchaseOrderItemDTO"> SELECT d.PO_NUM AS poNo, d.ITEM_CD
        AS itemCode, d.ITEM_DESC AS itemName, d.ITEM_SPEC AS specification, d.UNIT_CD AS unit,
        d.PO_QT AS orderQuantity, d.UNIT_PRC AS unitPrice, d.PO_AMT AS amount, d.DELY_DATE AS
        deliveryDate, d.TERM_PAY AS paymentTerms, d.WH_CD AS storageLocation, d.RMK AS remark,
        h.VENDOR_CD AS vendorCode, v.VENDOR_NM AS vendorName FROM PODT d INNER JOIN POHD h ON
        d.PO_NUM = h.PO_NUM LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD WHERE d.PO_NUM = #{poNo}
        AND d.DEL_FLAG = 'N' </select>

    <!-- 헤더 등록 -->
    <insert id="insertHeader"> INSERT INTO POHD ( PO_NUM, PO_SUBJECT, PO_DATE, PO_AMT, PROGRESS_CD,
        CTRL_USER_ID, CTRL_DEPT_CD, VENDOR_CD, PR_NUM, RFQ_NUM, PC_TYPE, REG_DATE, REG_USER_ID,
        DEL_FLAG, RMK ) VALUES ( #{dto.poNo}, #{dto.poName}, #{dto.poDate}, #{dto.totalAmount},
        #{dto.status}, #{dto.purchaseManager}, #{ctrlDeptCd}, #{dto.vendorCode}, #{dto.prNo},
        #{dto.rfqNo}, #{dto.purchaseType}, NOW(), #{regUserId}, 'N', #{dto.remark} ) </insert>

    <!-- 품목 등록 -->
    <insert id="insertItem"> INSERT INTO PODT ( PO_NUM, ITEM_CD, ITEM_DESC, ITEM_SPEC, UNIT_CD,
        PO_QT, UNIT_PRC, PO_AMT, DELY_DATE, TERM_PAY, WH_CD, REG_DATE, REG_USER_ID, DEL_FLAG, RMK )
        VALUES ( #{item.poNo}, #{item.itemCode}, #{item.itemName}, #{item.specification},
        #{item.unit}, #{item.orderQuantity}, #{item.unitPrice}, #{item.amount},
        #{item.deliveryDate}, #{item.paymentTerms}, #{item.storageLocation}, NOW(), #{regUserId},
        'N', #{item.remark} ) </insert>

    <!-- 헤더 수정 -->
    <update id="updateHeader"> UPDATE POHD SET PO_SUBJECT = #{dto.poName}, PO_DATE = #{dto.poDate},
        PO_AMT = #{dto.totalAmount}, VENDOR_CD = #{dto.vendorCode}, PC_TYPE = #{dto.purchaseType},
        RMK = #{dto.remark}, MOD_USER_ID = #{modUserId} WHERE PO_NUM = #{dto.poNo} </update>

    <!-- 상태 변경 -->
    <update id="updateStatus"> UPDATE POHD SET PROGRESS_CD = #{status}, MOD_USER_ID = #{userId}
        WHERE PO_NUM = #{poNo} </update>

    <!-- 상태 변경 + 반려 사유 저장 -->
    <update id="updateStatusWithReason"> UPDATE POHD SET PROGRESS_CD = #{status}, RMK =
        #{rejectReason}, MOD_USER_ID = #{userId} WHERE PO_NUM = #{poNo} </update>

    <!-- 협력사 수신확인 -->
    <update id="updateVendorConfirm"> UPDATE POHD SET CHECK_FLAG = 'Y', CHECK_DATE = NOW(),
        MOD_USER_ID = #{userId} WHERE PO_NUM = #{poNo} </update>

    <!-- 삭제 -->
    <update id="deleteHeader"> UPDATE POHD SET DEL_FLAG = 'Y' WHERE PO_NUM = #{poNo} </update>

    <!-- 발주 수정 시 기존 품목 물리적 삭제 (재등록 위해) -->
    <delete id="deleteItems"> DELETE FROM PODT WHERE PO_NUM = #{poNo} </delete>

    <!-- RFQ 선정완료(J) 목록 조회 (긴급/단가계약 PR 포함) -->
    <select id="selectRfqSelectedList" parameterType="map"
        resultType="com.company.erp.rfq.dto.RfqSelectedDTO"> SELECT h.RFQ_NUM AS rfqNo,
        h.RFQ_SUBJECT AS rfqName, h.RFQ_DATE AS rfqDate, vn.TOTAL_AMT AS rfqAmount, h.PC_TYPE AS
        purchaseType, vn.VENDOR_CD AS vendorCode, v.VENDOR_NM AS vendorName, h.CTRL_USER_ID AS
        ctrlUserId, u.USER_NM AS ctrlUserName, h.PR_NUM AS prNo, h.RMK AS remark FROM RFQHD h LEFT
        JOIN RFQVN vn ON h.RFQ_NUM = vn.RFQ_NUM AND vn.SELECT_YN = 'Y' LEFT JOIN VNGL v ON
        vn.VENDOR_CD = v.VENDOR_CD LEFT JOIN BY_USER u ON h.CTRL_USER_ID = u.USER_ID LEFT JOIN POHD
        po ON h.RFQ_NUM = po.RFQ_NUM WHERE h.PROGRESS_CD = 'J' AND h.DEL_FLAG = 'N' AND po.PO_NUM IS
        NULL <if test="rfqNo != null and rfqNo != ''"> AND h.RFQ_NUM LIKE CONCAT('%', #{rfqNo}, '%') </if>
        <if
            test="rfqName != null and rfqName != ''"> AND h.RFQ_SUBJECT LIKE CONCAT('%', #{rfqName},
        '%') </if>
        <if test="vendorName != null and vendorName != ''"> AND v.VENDOR_NM LIKE
        CONCAT('%', #{vendorName}, '%') </if>
        <if test="purchaseType != null and purchaseType != ''">
        AND h.PC_TYPE = #{purchaseType} </if>
        <if test="startDate != null and startDate != ''"> AND
        h.RFQ_DATE &gt;= #{startDate} </if>
        <if test="endDate != null and endDate != ''"> AND
        h.RFQ_DATE &lt;= #{endDate} </if> UNION ALL SELECT p.PR_NUM AS rfqNo, p.PR_SUBJECT AS
        rfqName, p.REG_DATE AS rfqDate, p.PR_AMT AS rfqAmount, p.PC_TYPE AS purchaseType, NULL AS
        vendorCode, NULL AS vendorName, p.CTRL_USER_ID AS ctrlUserId, u.USER_NM AS ctrlUserName,
        p.PR_NUM AS prNo, p.RMK AS remark FROM PRHD p LEFT JOIN BY_USER u ON p.CTRL_USER_ID =
        u.USER_ID LEFT JOIN CODD c ON p.PROGRESS_CD = c.CODE AND c.CODE_GROUP = 'PROGRESS_CD' LEFT
        JOIN POHD po ON p.PR_NUM = po.PR_NUM AND po.DEL_FLAG = 'N' WHERE c.CODE_NAME = '승인' AND
        p.PC_TYPE IN ('E', 'C') AND p.DEL_FLAG = 'N' AND po.PO_NUM IS NULL <if
            test="rfqNo != null and rfqNo != ''"> AND p.PR_NUM LIKE CONCAT('%', #{rfqNo}, '%') </if>
        <if
            test="rfqName != null and rfqName != ''"> AND p.PR_SUBJECT LIKE CONCAT('%', #{rfqName},
        '%') </if>
        <if test="vendorName != null and vendorName != ''"> AND 1=0 </if>
        <if
            test="purchaseType != null and purchaseType != ''"> AND p.PC_TYPE = #{purchaseType} </if>
        <if
            test="startDate != null and startDate != ''"> AND p.REG_DATE &gt;= #{startDate} </if>
        <if
            test="endDate != null and endDate != ''"> AND p.REG_DATE &lt;= #{endDate} </if> ORDER BY
        rfqDate DESC </select>

    <!-- RFQ 선정완료 품목 조회 -->
    <select id="selectRfqSelectedItems" parameterType="String"
        resultType="com.company.erp.rfq.dto.RfqSelectedItemDTO"> SELECT d.RFQ_NUM AS rfqNo,
        d.ITEM_CD AS itemCode, d.ITEM_DESC AS itemName, d.ITEM_SPEC AS specification, d.UNIT_CD AS
        unit, vd.QUOTE_QT AS quantity, vd.QUOTE_UNIT_PRC AS unitPrice, vd.QUOTE_AMT AS amount,
        vd.DELY_DATE AS deliveryDate, d.WH_NM AS storageLocation, d.RMK AS remark FROM RFQDT d LEFT
        JOIN RFQVNDT vd ON d.RFQ_NUM = vd.RFQ_NUM AND d.LINE_NO = vd.LINE_NO AND vd.SELECT_YN = 'Y'
        WHERE d.RFQ_NUM = #{rfqNo} AND d.DEL_FLAG = 'N' </select>

    <!-- PR 품목을 RfqSelectedItemDTO로 조회 (긴급/단가계약용) -->
    <select id="selectPrItemsAsRfqItems" parameterType="String"
        resultType="com.company.erp.rfq.dto.RfqSelectedItemDTO"> SELECT d.PR_NUM AS rfqNo, d.ITEM_CD
        AS itemCode, d.ITEM_DESC AS itemName, d.ITEM_SPEC AS specification, d.UNIT_CD AS unit,
        d.PR_QT AS quantity, d.UNIT_PRC AS unitPrice, d.PR_AMT AS amount, d.DELY_DATE AS
        deliveryDate, NULL AS storageLocation, d.RMK AS remark FROM PRDT d WHERE d.PR_NUM = #{prNum}
        AND d.DEL_FLAG = 'N' </select>

</mapper>