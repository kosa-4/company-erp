<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.company.erp.po.mapper.PurchaseOrderMapper">

    <!-- 목록 조회 (JOIN으로 협력사명 포함) -->
    <!-- 참고: API 명세서에 없는 공통 필드(REG_DATE, MOD_DATE 등)는 조회하지 않음 -->
    <select id="selectList" parameterType="map" resultType="com.company.erp.po.dto.PurchaseOrderDTO">
        SELECT h.PO_NUM as poNo, h.PO_SUBJECT as poName, h.PO_DATE as poDate, h.PO_AMT as
        totalAmount, h.PROGRESS_CD as status, h.CTRL_USER_ID as purchaseManager, h.VENDOR_CD as
        vendorCode, v.VENDOR_NM as vendorName, h.PR_NUM as prNo, h.RFQ_NUM as rfqNo, h.PC_TYPE as
        purchaseType, h.RMK as remark FROM POHD h LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD
        WHERE h.DEL_FLAG = 'N' <if test="poNo != null and poNo != ''"> AND h.PO_NUM LIKE CONCAT('%',
        #{poNo}, '%') </if>
        <if test="poName != null and poName != ''"> AND h.PO_SUBJECT LIKE
        CONCAT('%', #{poName}, '%') </if>
        <if
            test="purchaseManager != null and purchaseManager != ''"> AND h.CTRL_USER_ID =
        #{purchaseManager} </if>
        <if test="vendorName != null and vendorName != ''"> AND v.VENDOR_NM
        LIKE CONCAT('%', #{vendorName}, '%') </if>
        <if test="startDate != null and startDate != ''">
        AND h.PO_DATE >= #{startDate} </if>
        <if test="endDate != null and endDate != ''"> AND
        h.PO_DATE &lt;= #{endDate} </if>
        <if test="status != null and status != ''"> AND
        h.PROGRESS_CD = #{status} </if> ORDER BY h.REG_DATE DESC </select>

    <!-- 상세 조회 (헤더) -->
    <!-- 참고: API 명세서에 없는 공통 필드(REG_DATE, MOD_DATE 등)는 조회하지 않음 -->
    <select id="selectHeader" parameterType="String"
        resultType="com.company.erp.po.dto.PurchaseOrderDTO"> SELECT h.PO_NUM as poNo, h.PO_SUBJECT
        as poName, h.PO_DATE as poDate, h.PO_AMT as totalAmount, h.PROGRESS_CD as status,
        h.CTRL_USER_ID as purchaseManager, h.VENDOR_CD as vendorCode, v.VENDOR_NM as vendorName,
        h.PR_NUM as prNo, h.RFQ_NUM as rfqNo, h.PC_TYPE as purchaseType, h.RMK as remark FROM POHD h
        LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD WHERE h.PO_NUM = #{poNo} AND h.DEL_FLAG = 'N' </select>

    <!-- 상세 조회 (품목) - 발주 헤더의 협력사 정보 포함 -->
    <select id="selectItems" parameterType="String"
        resultType="com.company.erp.po.dto.PurchaseOrderItemDTO"> SELECT d.PO_NUM as poNo, d.ITEM_CD
        as itemCode, d.ITEM_DESC as itemName, d.ITEM_SPEC as specification, d.UNIT_CD as unit,
        d.PO_QT as orderQuantity, d.UNIT_PRC as unitPrice, d.PO_AMT as amount, d.DELY_DATE as
        deliveryDate, d.TERM_PAY as paymentTerms, d.WH_CD as storageLocation, d.RMK as remark,
        h.VENDOR_CD as vendorCode, v.VENDOR_NM as vendorName FROM PODT d INNER JOIN POHD h ON
        d.PO_NUM = h.PO_NUM LEFT JOIN VNGL v ON h.VENDOR_CD = v.VENDOR_CD WHERE d.PO_NUM = #{poNo}
        AND d.DEL_FLAG = 'N' </select>

    <!-- 헤더 등록 -->
    <!-- 참고: 
         - status는 Service 레이어에서 상태값 코드로 변환 후 전달 (기본값: "T")
         - regUserId는 DTO에 포함되지 않으므로 별도 파라미터로 전달
    -->
    <insert id="insertHeader"> INSERT INTO POHD ( PO_NUM, PO_SUBJECT, PO_DATE, PO_AMT, PROGRESS_CD,
        CTRL_USER_ID, VENDOR_CD, PR_NUM, RFQ_NUM, PC_TYPE, REG_DATE, REG_USER_ID, DEL_FLAG, RMK )
        VALUES ( #{dto.poNo}, #{dto.poName}, #{dto.poDate}, #{dto.totalAmount}, #{dto.status},
        #{dto.purchaseManager}, #{dto.vendorCode}, #{dto.prNo}, #{dto.rfqNo}, #{dto.purchaseType},
        NOW(), #{regUserId}, 'N', #{dto.remark} ) </insert>

    <!-- 품목 등록 -->
    <!-- 참고: regUserId는 DTO에 포함되지 않으므로 별도 파라미터로 전달 -->
    <insert id="insertItem"> INSERT INTO PODT ( PO_NUM, ITEM_CD, ITEM_DESC, ITEM_SPEC, UNIT_CD,
        PO_QT, UNIT_PRC, PO_AMT, DELY_DATE, TERM_PAY, WH_CD, REG_DATE, REG_USER_ID, DEL_FLAG, RMK )
        VALUES ( #{item.poNo}, #{item.itemCode}, #{item.itemName}, #{item.specification},
        #{item.unit}, #{item.orderQuantity}, #{item.unitPrice}, #{item.amount},
        #{item.deliveryDate}, #{item.paymentTerms}, #{item.storageLocation}, NOW(), #{regUserId},
        'N', #{item.remark} ) </insert>

    <!-- 헤더 수정 -->
    <!-- 참고: modUserId는 DTO에 포함되지 않으므로 별도 파라미터로 전달 -->
    <update id="updateHeader"> UPDATE POHD SET PO_SUBJECT = #{dto.poName}, PO_DATE = #{dto.poDate},
        PO_AMT = #{dto.totalAmount}, VENDOR_CD = #{dto.vendorCode}, PC_TYPE = #{dto.purchaseType},
        RMK = #{dto.remark}, MOD_DATE = NOW(), MOD_USER_ID = #{modUserId} WHERE PO_NUM = #{dto.poNo} </update>

    <!-- 상태 변경 -->
    <update id="updateStatus"> UPDATE POHD SET PROGRESS_CD = #{status}, MOD_DATE = NOW(),
        MOD_USER_ID = #{userId} WHERE PO_NUM = #{poNo} </update>

    <!-- 상태 변경 + 반려 사유 저장 -->
    <update id="updateStatusWithReason"> UPDATE POHD SET PROGRESS_CD = #{status}, RMK =
        #{rejectReason}, MOD_DATE = NOW(), MOD_USER_ID = #{userId} WHERE PO_NUM = #{poNo} </update>

    <!-- 삭제 (논리 삭제) -->
    <update id="deleteHeader"> UPDATE POHD SET DEL_FLAG = 'Y', MOD_DATE = NOW() WHERE PO_NUM =
        #{poNo} </update>

    <update id="deleteItems"> UPDATE PODT SET DEL_FLAG = 'Y', MOD_DATE = NOW() WHERE PO_NUM =
        #{poNo} </update>

</mapper>